{% macro content_chat() %}
<div id="chat-messages" style="height: 200px; overflow-y: auto; border: 1px solid var(--neon-cyan); border-radius: 8px; padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.3);">
    <!-- Mensajes del chat -->
</div>
<div class="input-group">
    <input type="text" id="chat-input" class="form-control" placeholder="Escribe un mensaje...">
    <button id="chatEnviarMensaje" class="btn btn-primary">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>
{% endmacro %}

{% macro content_chat_notifications () %}
<div id="chatNotificationContainer" class="toast-container position-fixed bottom-0 end-0 p-3">
</div>
{% endmacro %}

{% macro content_lista_usuarios() %}
<div id="jugadores-container" class="row g-2">
    <!-- Se actualizar√° din√°micamente -->
</div>
{% endmacro %}

<!-- NUEVO MACRO PARA MODALES DE BLOQUEO -->
{% macro content_modales() %}
<div class="modal fade" id="modalBloquearUsuario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="fs-1">üõë</div>
                    <h4 class="modal-title mt-2 mb-2">Bloquear usuario</h4>
                    <p>
                        ¬øEst√°s seguro que deseas bloquear a <span id="nombreUsuarioBloquear" class="font-monospace"></span>?
                        <br>
                        No ver√°s sus mensajes en el chat.
                    </p>
                </div>
                <div class="alert alert-info mt-3 mb-0">
                    <small>
                        <i class="fa-solid fa-circle-info me-1"></i>Puedes deshacer esta acci√≥n en cualquier momento a lo largo de esta partida o en cualquier otra sala multijugador no creada por este usuario.
                    </small>
                </div>
            </div>
            <div class="modal-footer border-neon">
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">
                    <i class="fa-solid fa-ban me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmarBloquear">
                    <i class="fa-solid fa-circle-stop me-1"></i>Bloquear
                </button>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{% macro scripts() %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const salaId = {{ sala.id }};
    const esCreador = {{ 'true' if sala.creador_id == current_user.id else 'false' }};
    const socket = window.socket;
    const maxNotifications = 3;
    
    // Lista de usuarios bloqueados (inicialmente vac√≠a)
    let usuariosBloqueados = new Set();
    
    // Cargar usuarios bloqueados al iniciar
    cargarUsuariosBloqueados();

    async function cargarUsuariosBloqueados() {
        try {
            const response = await fetch(`/api/multijugador/usuarios-bloqueados/${salaId}`);
            if (response.ok) {
                const data = await response.json();
                usuariosBloqueados = new Set(data.usuarios_bloqueados || []);
                console.log('Usuarios bloqueados cargados:', Array.from(usuariosBloqueados));
            }
        } catch (error) {
            console.error('Error cargando usuarios bloqueados:', error);
        }
    }

    function actualizarListaJugadores() {
        fetch(`/api/multijugador/estado-sala/${salaId}`)
            .then(response => response.json())
            .then(data => {                
                const container = document.getElementById('jugadores-container');

                // Eliminar tooltips de Bootstrap de los elementos del contenedor
                // (como se va a actualizar el contenedor, es posible que los 
                // tooltips que hab√≠a abiertos antes de la actualizaci√≥n no
                // desaparezcan, si no hacemos esto).
                const elements = container.querySelectorAll('[data-bs-toggle="tooltip"]');
                elements.forEach(el => {
                    const tooltip = bootstrap.Tooltip.getInstance(el);
                    if (tooltip) {
                        tooltip.hide();
                        tooltip.dispose();
                    }
                });

                container.innerHTML = data.jugadores.map(jugador => {
                    const esUsuarioActual = jugador.id === {{ current_user.id }};
                    const estaBloqueado = usuariosBloqueados.has(jugador.id);
                    
                    // Escape del username para JavaScript
                    const usernameEscaped = jugador.username.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    return `
                    <div class="col-md-6">
                        <div class="card translucent-card ${jugador.es_creador ? 'border-primary' : ''}">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <!-- LADO IZQUIERDO: Icono + Nombre -->
                                    <div class="d-flex align-items-center" style="min-width: 0;">
                                        <i class="fas fa-user${jugador.es_creador ? '-crown' : estaBloqueado ? '-slash' : ''} me-2" 
                                           style="color: ${jugador.es_creador ? 'var(--neon-cyan)' : estaBloqueado ? 'var(--neon-red)' : 'var(--text-light)'};"></i>
                                        <span class="text-truncate fw-bold">${jugador.username}</span>
                                    </div>
                                    
                                    <!-- LADO DERECHO: Etiquetas + Botones -->
                                    <div class="d-flex align-items-center gap-2">
                                        <!-- Etiqueta Creador (AHORA A LA DERECHA) -->
                                        ${jugador.es_creador ? '<span class="badge bg-primary">Creador</span>' : ''}
                                        
                                        <!-- Botones de acci√≥n -->
                                        ${!esUsuarioActual && !jugador.es_creador && esCreador ? 
                                            `<div class="btn-group btn-group-sm">
                                                ${!estaBloqueado ? 
                                                    `<button class="btn btn-sm btn-outline-warning" 
                                                            onclick="mostrarModalBloquear(${jugador.id}, '${usernameEscaped}')"
                                                            data-bs-toggle="tooltip"
                                                            data-bs-placement="left"
                                                            data-bs-title="Bloquear usuario">
                                                        <i class="fas fa-circle-stop"></i>
                                                    </button>` :
                                                    `<button class="btn btn-sm btn-outline-success" 
                                                            onclick="desbloquearUsuario(${jugador.id})"
                                                            data-bs-toggle="tooltip"
                                                            data-bs-placement="left"
                                                            data-bs-title="Desbloquear usuario">
                                                        <i class="fas fa-check"></i>
                                                    </button>`
                                                }
                                            </div>` : ''
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                // Volver a inicializar tooltips de Bootstrap de elementos del contenedor.
                var tooltipTriggerList = [].slice.call(
                    container.querySelectorAll('[data-bs-toggle="tooltip"]')
                );
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            })
            .catch(error => console.error('Error:', error));
    }

    // Funci√≥n global para mostrar modal de bloqueo (CON DEPURACI√ìN)
    window.mostrarModalBloquear = function(usuarioId, username) {
        console.log('üîÑ Mostrando modal para usuario:', usuarioId, username);
        
        // Verificar que el modal existe
        const modalElement = document.getElementById('modalBloquearUsuario');
        const nombreElement = document.getElementById('nombreUsuarioBloquear');
        
        if (!modalElement) {
            console.error('‚ùå No se encontr√≥ el modal con id "modalBloquearUsuario"');
            alert('Error: No se puede cargar el modal de bloqueo. Recarga la p√°gina.');
            return;
        }
        
        if (!nombreElement) {
            console.error('‚ùå No se encontr√≥ el elemento "nombreUsuarioBloquear"');
            alert('Error: Elemento del nombre no encontrado.');
            return;
        }
        
        // Configurar el nombre
        nombreElement.textContent = username;
        console.log('‚úÖ Nombre establecido en modal:', username);
        
        // Mostrar modal
        const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
        
        modal.show();
        console.log('‚úÖ Modal mostrado');
        
        // Configurar el bot√≥n de confirmar
        const confirmarBtn = document.getElementById('confirmarBloquear');
        if (confirmarBtn) {
            // Remover eventos anteriores
            confirmarBtn.onclick = null;
            
            // Asignar nuevo evento
            confirmarBtn.onclick = function() {
                console.log('‚úÖ Confirmando bloqueo para usuario:', usuarioId);
                bloquearUsuario(usuarioId);
                modal.hide();
            };
            console.log('‚úÖ Bot√≥n de confirmar configurado');
        }
    };

    window.desbloquearUsuario = async function(usuarioId) {
        console.log('üîì EJECUTANDO DESBLOQUEO para usuario:', usuarioId);
        
        try {
            const url = `/api/multijugador/desbloquear-usuario/${salaId}/${usuarioId}`;
            console.log('üì§ Enviando POST a:', url);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            });
            
            console.log('üì• Respuesta recibida - Status:', response.status);
            console.log('üì• Respuesta recibida - OK?', response.ok);
            
            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ Datos respuesta:', data);
                
                usuariosBloqueados.delete(usuarioId);
                actualizarListaJugadores();
                mostrarNotificacion('Usuario desbloqueado exitosamente', 'success');
            } else {
                const error = await response.json();
                console.error('‚ùå Error del servidor:', error);
                mostrarNotificacion(error.error || 'Error al desbloquear usuario', 'error');
            }
        } catch (error) {
            console.error('‚ùå Error de conexi√≥n:', error);
            mostrarNotificacion('Error de conexi√≥n', 'error');
        }
    };

    async function bloquearUsuario(usuarioId) {
        console.log('üîí EJECUTANDO BLOQUEO para usuario:', usuarioId);
        
        try {
            const url = `/api/multijugador/bloquear-usuario/${salaId}/${usuarioId}`;
            console.log('üì§ Enviando POST a:', url);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            });
            
            console.log('üì• Respuesta recibida - Status:', response.status);
            console.log('üì• Respuesta recibida - OK?', response.ok);
            
            const data = await response.json();
            console.log('üìä Datos de respuesta:', data);
            
            if (response.ok) {
                console.log('‚úÖ Bloqueo exitoso, actualizando lista...');
                usuariosBloqueados.add(usuarioId);
                actualizarListaJugadores();
                mostrarNotificacion('Usuario bloqueado exitosamente', 'success');
            } else {
                console.error('‚ùå Error del servidor:', data);
                mostrarNotificacion(data.error || 'Error al bloquear usuario', 'error');
            }
        } catch (error) {
            console.error('‚ùå Error de conexi√≥n:', error);
            mostrarNotificacion('Error de conexi√≥n: ' + error.message, 'error');
        }
    }

    function eliminarMensajesUsuario(usuarioId) {
        const mensajes = document.querySelectorAll('.chat-message[data-user-id]');
        mensajes.forEach(mensaje => {
            const userId = parseInt(mensaje.dataset.userId);
            if (userId === usuarioId) {
                mensaje.remove();
            }
        });
    }

    // CHAT FUNCTIONS
    function enviarMensaje() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (message) {
            console.log('üì§ Enviando mensaje de chat:', message);
            socket.emit('chat_message', {
                sala_id: salaId,
                message: message,
                timestamp: new Date().toISOString()
            });
            input.value = '';
        }
    }

    document.getElementById("chatEnviarMensaje").addEventListener("click", function () {
        enviarMensaje();
    });

    // MODIFICAR EL HANDLER DE MENSAJES PARA FILTRAR BLOQUEADOS
    socket.on('new_message', (data) => {
        // Verificar si el usuario est√° bloqueado
        if (usuariosBloqueados.has(data.user_id)) {
            console.log(`üö´ Mensaje bloqueado de usuario ID ${data.user_id} (${data.username})`);
            return; // No mostrar el mensaje
        }
        
        agregarMensajeChat(data.username, data.message, 'user', data.user_id);
    });

    // Eventos de SocketIO
    socket.on('user_joined', (data) => {
        actualizarListaJugadores();
        agregarMensajeChat('Sistema', `${data.username} se uni√≥ a la sala`, 'system');
    });

    socket.on('user_left', (data) => {
        actualizarListaJugadores();
        agregarMensajeChat('Sistema', `${data.username} sali√≥ de la sala`, 'system');
    });

    function agregarMensajeChat(usuario, mensaje, tipo, userId = null) {
        const chat = document.getElementById('chat-messages');
        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `chat-message ${tipo}`;
        if (userId) {
            mensajeDiv.dataset.userId = userId;
        }
        mensajeDiv.innerHTML = `
            <strong>${usuario}:</strong> ${mensaje}
            <small class="text-muted">${new Date().toLocaleTimeString()}</small>
        `;
        chat.appendChild(mensajeDiv);
        chat.scrollTop = chat.scrollHeight;

        // Mostrar tambi√©n notificaci√≥n si est√° habilitada
        if (window.showNotifications) {
            agregarNotificacionChat(usuario, mensaje, tipo);
        }
    }

    function agregarNotificacionChat(usuario, mensaje, tipo) {
        if (!window.showNotifications) {
            return;
        }

        const notificationsContainer = document.getElementById('chatNotificationContainer');

        const notificationDiv = document.createElement('div');
        notificationDiv.className = `toast`;
        notificationDiv.role = 'alert';
        notificationDiv.ariaLive = 'assertive';
        notificationDiv.ariaAtomic = 'true';
        notificationDiv.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">
                    <i class="fas fa-comments me-2"></i>Chat de sala
                </strong>
                <small>${new Date().toLocaleTimeString()}</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body notification-message ${tipo}">
                <strong>${usuario}:</strong> ${mensaje}
            </div>
        `;
        notificationsContainer.appendChild(notificationDiv);

        const notificationDivBootstrap = bootstrap.Toast.getOrCreateInstance(notificationDiv);
        notificationDivBootstrap.show();

        if (notificationsContainer.children.length > maxNotifications) {
            const notificacionMasAntigua = notificationsContainer.children[0];
            notificacionMasAntigua.remove();
        }
    }

    // Permitir enviar mensaje con Enter
    document.getElementById('chat-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            enviarMensaje();
        }
    });

    // Funci√≥n para mostrar notificaciones
    function mostrarNotificacion(mensaje, tipo) {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${tipo === 'success' ? 'success' : 'danger'} border-0`;
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${mensaje}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        const container = document.getElementById('chatNotificationContainer');
        container.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        setTimeout(() => {
            if (toast.parentNode === container) {
                toast.remove();
            }
        }, 5000);
    }

    // Actualizar cada 3 segundos (como fallback)
    setInterval(actualizarListaJugadores, 3000);
    actualizarListaJugadores();
});

// Funci√≥n de API para limpiar todas las notificaciones.
function limpiarNotificaciones() {
    const notificationsContainer = document.getElementById('chatNotificationContainer');
    const toasts = notificationsContainer.querySelectorAll('.toast');
    toasts.forEach(toast => {
        toast.remove();
    });
}
</script>

<style>
.chat-message {
    margin-bottom: 8px;
    padding: 8px;
    border-radius: 8px;
}

.notification-message {
    padding: 8px;
}

.chat-message.user, .notification-message.user {
    background: rgba(0, 243, 255, 0.1);
    border-left: 3px solid var(--neon-cyan);
}

.chat-message.system, .notification-message.system {
    background: rgba(255, 0, 255, 0.1);
    border-left: 3px solid var(--neon-pink);
    font-style: italic;
}

.border-primary {
    border: 2px solid var(--neon-cyan) !important;
}

/* Nuevos estilos para bloqueo */
.border-danger {
    border: 2px solid var(--neon-red) !important;
}

.opacity-75 {
    opacity: 0.75;
}

/* Estilos para botones de bloqueo */
.btn-outline-warning {
    color: #ffc107;
    border-color: #ffc107;
}

.btn-outline-warning:hover {
    background-color: #ffc107;
    color: #000;
}

.btn-outline-success {
    color: #198754;
    border-color: #198754;
}

.btn-outline-success:hover {
    background-color: #198754;
    color: #fff;
}
</style>
{% endmacro %}