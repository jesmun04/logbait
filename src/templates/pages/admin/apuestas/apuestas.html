{% extends "pages/admin/base.html" %}

{% block title %}
Apuestas
{% endblock %}

{% block content %}
<h1>ğŸ° GestiÃ³n de Apuestas</h1>

<div class="row g-3 mt-3">
    <!-- Tarjetas de Resumen Mejoradas -->
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card animated-rotate h-100">
            <div class="card-body text-center p-2">
                <div class="fs-2">ğŸ’°</div>
                <h6 class="mb-1">Total</h6>
                <div class="stat-number">{{ apuestas.total }}</div>
                <small class="text-muted">Apuestas</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card animated-rotate h-100">
            <div class="card-body text-center p-2">
                <div class="fs-2">ğŸ“Š</div>
                <h6 class="mb-1">PÃ¡gina</h6>
                <div class="stat-number text-info">{{ apuestas.page }}</div>
                <small class="text-muted">de {{ apuestas.pages }}</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card animated-rotate h-100">
            <div class="card-body text-center p-2">
                <div class="fs-2">ğŸ”„</div>
                <h6 class="mb-1">Por PÃ¡gina</h6>
                <div class="stat-number text-warning">{{ apuestas.per_page }}</div>
                <small class="text-muted">Registros</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card animated-rotate h-100">
            <div class="card-body text-center p-2">
                <div class="fs-2">âœ…</div>
                <h6 class="mb-1">Ganadas</h6>
                <div class="stat-number text-success">{{ apuestas_ganadas }}</div>
                <small class="text-muted">Victorias</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card animated-rotate h-100">
            <div class="card-body text-center p-2">
                <div class="fs-2">âŒ</div>
                <h6 class="mb-1">Perdidas</h6>
                <div class="stat-number text-danger">{{ apuestas_perdidas }}</div>
                <small class="text-muted">Derrotas</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card animated-rotate h-100">
            <div class="card-body text-center p-2">
                <div class="fs-2">âš¡</div>
                <h6 class="mb-1">Filtros</h6>
                <div class="stat-number {% if juego_actual or resultado_actual %}text-success{% else %}text-muted{% endif %}">
                    {% if juego_actual or resultado_actual %}ON{% else %}OFF{% endif %}
                </div>
                <small class="text-muted">Activos</small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card animated-translateY">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="d-flex align-items-center gap-3">
                            <h4 class="mb-0">ğŸ¯ Historial de Apuestas</h4>
                            {% if juego_actual or resultado_actual %}
                            <span class="badge text-bg-info">Filtrado</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="me-2 small">Mostrando</span>
                        <span class="badge text-bg-light">{{ apuestas.items|length }}</span>
                    </div>
                </div>
            </div>
            <div class="card-body p-3">
                <!-- Filtros AutomÃ¡ticos Mejorados -->
                <div class="row g-3 mb-4">
                    <div class="col-lg-5 col-md-6">
                        <div>
                            <label class="mb-1 fw-bold">Filtrar por Juego</label>
                            <select class="form-select data-filter-select" id="juegoFilter">
                                <option value="">Todos los juegos</option>
                                <option value="blackjack" {% if juego_actual == 'blackjack' %}selected{% endif %}>ğŸ² Blackjack</option>
                                <option value="poker" {% if juego_actual == 'poker' %}selected{% endif %}>ğŸƒ Poker</option>
                                <option value="coinflip" {% if juego_actual == 'coinflip' %}selected{% endif %}>ğŸª™ Coinflip</option>
                                <option value="tragaperras" {% if juego_actual == 'tragaperras' %}selected{% endif %}>ğŸ° Tragaperras</option>
                                <option value="caballos" {% if juego_actual == 'caballos' %}selected{% endif %}>ğŸ‡ Carrera de Caballos</option>
                                <option value="ruleta" {% if juego_actual == 'ruleta' %}selected{% endif %}>ğŸ¯ Ruleta</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-5 col-md-6">
                        <div>
                            <label class="mb-1 fw-bold">Filtrar por Resultado</label>
                            <select class="form-select data-filter-select" id="resultadoFilter">
                                <option value="">Todos los resultados</option>
                                <option value="ganada" {% if resultado_actual == 'ganada' %}selected{% endif %}>âœ… Ganadas</option>
                                <option value="perdida" {% if resultado_actual == 'perdida' %}selected{% endif %}>âŒ Perdidas</option>
                                <option value="empate" {% if resultado_actual == 'empate' %}selected{% endif %}>âš¡ Empates</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-12 d-flex align-items-end">
                        <button class="btn btn-outline-primary w-100" onclick="clearFilters()" 
                                {% if not juego_actual and not resultado_actual %}disabled{% endif %}>
                            <i class="fa-solid fa-trash me-1"></i>Limpiar
                        </button>
                    </div>
                </div>

                <!-- Indicador de Filtros Activos -->
                {% if juego_actual or resultado_actual %}
                <div class="alert alert-cyber mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>ğŸ›ï¸ Filtros Activos:</strong>
                            {% if juego_actual %}
                            <span class="badge bg-game me-2">ğŸ® {{ juego_actual|title }}</span>
                            {% endif %}
                            {% if resultado_actual %}
                            <span class="badge bg-result">ğŸ¯ {{ resultado_actual|title }}</span>
                            {% endif %}
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="me-2">ğŸ“Š</span>
                            <strong class="text-cyan">{{ apuestas.total }}</strong>
                            <span class="ms-1">apuestas encontradas</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Tabla Mejorada -->
                <div class="table-responsive">
                    <table class="table table-cyber">
                        <thead class="cyber-thead">
                            <tr>
                                <th class="cyber-th">ID</th>
                                <th class="cyber-th">Usuario</th>
                                <th class="cyber-th">Fecha</th>
                                <th class="cyber-th">Juego</th>
                                <th class="cyber-th">Modo</th>
                                <th class="cyber-th">Resultado</th>
                                <th class="cyber-th">Apuesta</th>
                                <th class="cyber-th">Ganancia</th>
                                <th class="cyber-th">Neto</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for apuesta in apuestas.items %}
                            <tr>
                                <th scope="row">
                                    <span class="small text-cyan">#{{ apuesta.id }}</span>
                                </th>
                                <td>
                                    <a href="{{ url_for('admin_usuarios.detalle_usuario', user_id=apuesta.user.id) }}" class="text-decoration-none">
                                    <div class="d-flex flex-row align-items-center gap-2">
                                        <div class="user-avatar">
                                            {{ apuesta.user.username[0]|upper }}
                                        </div>
                                        <strong class="data-username">{{ apuesta.user.username }}</strong>
                                    </div>
                                    </a>
                                </td>
                                <td>
                                    <div title="{{ apuesta.fecha.strftime('%d/%m/%Y %H:%M:%S') }}">
                                        <span>{{ apuesta.fecha.strftime('%d/%m/%Y') }}</span>
                                        <br>
                                        <small class="text-muted">{{ apuesta.fecha.strftime('%H:%M') }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="game-badge game-{{ apuesta.juego }}">
                                        {% if apuesta.juego == 'blackjack' %}ğŸ²
                                        {% elif apuesta.juego == 'poker' %}ğŸƒ
                                        {% elif apuesta.juego == 'coinflip' %}ğŸª™
                                        {% elif apuesta.juego == 'tragaperras' %}ğŸ°
                                        {% elif apuesta.juego == 'caballos' %}ğŸ‡
                                        {% elif apuesta.juego == 'ruleta' %}ğŸ¯
                                        {% else %}ğŸ®{% endif %}
                                        {{ apuesta.juego|title }}
                                    </span>
                                </td>
                                <td>
                                    {% if apuesta.tipo_juego == 'singleplayer' %}
                                    <span class="badge text-bg-light">
                                        <i class="fas fa-user me-1"></i>Un jugador
                                    </span>
                                    {% else %}
                                    <span class="badge text-bg-light">
                                        <i class="fas fa-users me-1"></i>Multijugador
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge rounded-pill
                                      {% if apuesta.resultado == 'ganada' %}text-bg-success
                                      {% elif apuesta.resultado == 'perdida' %}text-bg-danger
                                      {% elif apuesta.resultado == 'empate' %}text-bg-warning
                                      {% endif %}">
                                        {{ apuesta.resultado|title }}
                                    </span>
                                </td>
                                <td>
                                    <span class="small {% if apuesta.cantidad > 0 %}balance-positive{% elif apuesta.cantidad < 0 %}balance-negative{% else %}balance-neutral{% endif %}">
                                        ${{ "%.2f"|format(apuesta.cantidad) }}
                                    </span>
                                </td>
                                <td>
                                    <span class="small {% if apuesta.ganancia > 0 %}balance-positive{% elif apuesta.ganancia < 0 %}balance-negative{% else %}balance-neutral{% endif %}">
                                        ${{ "%.2f"|format(apuesta.ganancia) }}
                                    </span>
                                </td>
                                <td>
                                    <span class="{% if (apuesta.ganancia - apuesta.cantidad) > 0 %}balance-positive{% elif (apuesta.ganancia - apuesta.cantidad) < 0 %}balance-negative{% else %}balance-neutral{% endif %}">
                                        ${{ "%.2f"|format(apuesta.ganancia - apuesta.cantidad) }}
                                    </span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center py-5 pe-none">
                                    <div>
                                        <div class="fs-1">ğŸ“­</div>
                                        <h5 class="text-muted mt-3">No se encontraron apuestas</h5>
                                        <p class="text-muted mb-0">
                                            {% if juego_actual or resultado_actual %}
                                            No hay apuestas que coincidan con los filtros aplicados
                                            {% else %}
                                            No hay apuestas registradas en el sistema
                                            {% endif %}
                                        </p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- PaginaciÃ³n Mejorada -->
                {% if apuestas.pages > 1 %}
                <nav aria-label="PaginaciÃ³n de apuestas" class="mt-4">
                    <ul class="pagination cyber-pagination justify-content-center">
                        {% if apuestas.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin_apuestas.home', page=apuestas.prev_num, juego=juego_actual, resultado=resultado_actual) }}">
                                    â† Anterior
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">â† Anterior</span>
                            </li>
                        {% endif %}
                        
                        {% for page_num in apuestas.iter_pages(left_edge=1, left_current=2, right_current=2, right_edge=1) %}
                            {% if page_num %}
                                <li class="page-item {% if page_num == apuestas.page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('admin_apuestas.home', page=page_num, juego=juego_actual, resultado=resultado_actual) }}">
                                        {{ page_num }}
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if apuestas.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin_apuestas.home', page=apuestas.next_num, juego=juego_actual, resultado=resultado_actual) }}">
                                    Siguiente â†’
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Siguiente â†’</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filtros automÃ¡ticos con debounce
let filterTimeout;

function applyFilters() {
    const juego = document.getElementById('juegoFilter').value;
    const resultado = document.getElementById('resultadoFilter').value;
    
    // Construir URL con parÃ¡metros
    const params = new URLSearchParams();
    if (juego) params.set('juego', juego);
    if (resultado) params.set('resultado', resultado);
    params.set('page', '1');
    
    window.location.href = '{{ url_for("admin_apuestas.home") }}?' + params.toString();
}

function clearFilters() {
    window.location.href = '{{ url_for("admin_apuestas.home") }}';
}

// Filtro automÃ¡tico con retardo
function setupAutoFilters() {
    const selects = document.querySelectorAll('.data-filter-select');
    
    selects.forEach(select => {
        select.addEventListener('change', function() {
            // Clear previous timeout
            clearTimeout(filterTimeout);
            
            // Show loading state
            const cardBody = document.querySelector('.card-body');
            cardBody.style.opacity = '0.7';
            
            // Apply filters after short delay
            filterTimeout = setTimeout(() => {
                applyFilters();
            }, 500);
        });
    });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    setupAutoFilters();
});
</script>
{% endblock %}