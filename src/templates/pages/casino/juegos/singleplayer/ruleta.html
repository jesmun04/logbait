{% extends "pages/casino/base.html" %}

{% block title %}
Ruleta Europea
{% endblock %}

{% block content %}
<div class="ruleta-breakout">
<div class="ruleta-page">
  <div class="ruleta-header">
    <div>
      <p class="ruleta-section-label text-uppercase text-muted mb-1">Modo singleplayer</p>
      <h2 class="ruleta-heading mb-0">ðŸŽ¯ Ruleta europea</h2>
    </div>
    <div class="balances">
      <span class="pill">Banco: <b id="bank">0</b>Â¢</span>
      <span class="pill">Apuesta actual: <b id="betTotal">0</b>Â¢</span>
      <span class="pill">Ãšltima acciÃ³n: <span id="lastAction">â€”</span></span>
    </div>
    <div class="ms-auto">
      <a href="{{ url_for('dashboard.home') }}" class="btn btn-outline-primary btn-sm">
        <i class="fas fa-gauge me-1"></i>Dashboard
      </a>
    </div>
  </div>

  <div class="ruleta-ui mt-4">
    <div class="ruleta-grid">
      <section class="panel wheel-wrap">
          <svg id="wheel" viewBox="-220 -220 440 440" aria-label="ruleta">
            <defs>
              <radialGradient id="rim" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="#c08a26" />
                <stop offset="70%" stop-color="#8a5e10" />
                <stop offset="100%" stop-color="#5a3b08" />
              </radialGradient>
            </defs>
            <circle r="210" fill="url(#rim)" />
            <g id="numbers"></g>
            <circle r="110" fill="#2f7a3d" />
            <circle r="20" fill="#1a4a25" />
            <circle id="ball" r="6" fill="#f3efe2" cx="0" cy="-170" />
          </svg>
          <div class="controls">
            <button id="spinBtn" class="btn">Girar</button>
            <button id="clearBtn" class="btn secondary">Borrar jugada</button>
            <button id="undoBtn" class="btn secondary">Deshacer</button>
            <button id="dupBtn" class="btn">Duplicar apuesta</button>
            <button id="repeatBtn" class="btn">Ãšltima jugada</button>
            <label class="pill pill-toggle">
              <input type="checkbox" id="instantToggle">
              Modo instantÃ¡neo
            </label>
          </div>
        </section>
      <section class="panel ruleta-panel-table">
          <div class="chips" id="chips">
            <div class="chip" draggable="true" data-value="20">0,20â‚¬</div>
            <div class="chip" draggable="true" data-value="50">0,50â‚¬</div>
            <div class="chip" draggable="true" data-value="100">1â‚¬</div>
            <div class="chip" draggable="true" data-value="200">2â‚¬</div>
            <div class="chip" draggable="true" data-value="500">5â‚¬</div>
            <div class="chip" draggable="true" data-value="1000">10â‚¬</div>
            <label class="pill pill-inline ms-auto">
              + Moneda:
              <input id="customChip" type="number" min="10" step="10" value="250">Â¢
              <button id="addChip" class="btn secondary">AÃ±adir</button>
            </label>
          </div>

          <div class="bets-buttons">
            <button class="btn" id="voisinsBtn">Vecinos del 0</button>
            <button class="btn" id="tiersBtn">Tiers</button>
            <button class="btn" id="orphBtn">HuÃ©rfanos</button>
          </div>

          <div class="table" id="layout"></div>

          <div class="group mt-4">
            <h3 class="group-title">Apuestas exteriores</h3>
            <div class="bets-buttons flex-wrap">
              <button class="btn" data-out="red">Rojo</button>
              <button class="btn" data-out="black">Negro</button>
              <button class="btn" data-out="even">Par</button>
              <button class="btn" data-out="odd">Impar</button>
              <button class="btn" data-out="low">1â€“18</button>
              <button class="btn" data-out="high">19â€“36</button>
              <button class="btn" data-out="d1">1Âª Docena</button>
              <button class="btn" data-out="d2">2Âª Docena</button>
              <button class="btn" data-out="d3">3Âª Docena</button>
              <button class="btn" data-out="c1">Columna 1</button>
              <button class="btn" data-out="c2">Columna 2</button>
              <button class="btn" data-out="c3">Columna 3</button>
            </div>
          </div>

          <div class="log mt-4" id="log"></div>
        </section>
    </div>
  </div>

  <p class="ruleta-note text-center text-muted small mb-0 mt-4">
    Demo educativa. MÃ­nimo por casilla: 20Â¢.
  </p>
</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
/* ================== DATOS Y ESTADO ================== */
const EURO_SEQ = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const REDS = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
const ALL = Array.from({length:36},(_,i)=>i+1);

const PAYOUT = { straight:35, split:17, street:11, corner:8, line:5, dozen:2, column:2, even:1 };

const bankEl=document.getElementById('bank'); const betTotalEl=document.getElementById('betTotal'); const lastActionEl=document.getElementById('lastAction'); const logEl=document.getElementById('log');
let bank=0; let bets=[]; let history=[]; let lastBets=[]; let spinning=false;

let instantMode=false;
document.getElementById('instantToggle').addEventListener('change', (e)=>{
  instantMode = e.target.checked;
  lastActionEl.textContent = instantMode ? 'Modo instantÃ¡neo ON' : 'Modo instantÃ¡neo OFF';
});

/* ================== FORMATO Y LOG ================== */
function centsToEuro(c){ return (c/100).toLocaleString('es-ES',{style:'currency',currency:'EUR'}); }
function flash(t){ lastActionEl.textContent=t; }
function log(t){ const p=document.createElement('div'); p.innerHTML=t; logEl.prepend(p); }

/* ================== API BACKEND (opcional) ================== */
function renderStats(stats){
  if(!stats) return;
  const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent = (v||0); };
  set('spins', stats.spins);
  set('betCents', stats.bet_cents);
  set('winCents', stats.win_cents);
  set('retCents', stats.returned_cents);
  set('netCents', stats.net_cents);
}
async function refreshState(){
  try{
    const s = await apiGET('/api/ruleta/state');
    if (s && typeof s.balance === 'number' && s.balance > 0) {
      bank = s.balance; updateTotals(); renderStats(s.stats); return;
    }
  }catch(e){}

  try{
    const a = await apiGET('/api/account/state');
    if (a && a.ok) {
      bank = (typeof a.balance === 'number') ? a.balance : Math.round((a.balance_float || 0) * 100);
      updateTotals(); if (a.ruleta_stats) renderStats(a.ruleta_stats);
    }
  }catch(e){}
}

async function apiGET(url){ const r=await fetch(url,{credentials:'same-origin'}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function apiPOST(url, body){ const r=await fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, credentials:'same-origin', body: JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
(async()=>{ await refreshState(); })();

/* ================== SVG RUEDA ================== */
const gNums=document.getElementById('numbers'); const ball=document.getElementById('ball'); const R_OUT=190, R_TEXT=165;
EURO_SEQ.forEach((n,idx)=>{
  const a0=(2*Math.PI/EURO_SEQ.length)*idx-Math.PI/2;
  const a1=(2*Math.PI/EURO_SEQ.length)*(idx+1)-Math.PI/2;
  const x0=R_OUT*Math.cos(a0), y0=R_OUT*Math.sin(a0);
  const x1=R_OUT*Math.cos(a1), y1=R_OUT*Math.sin(a1);
  const p=document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('d',`M ${x0.toFixed(2)} ${y0.toFixed(2)} A ${R_OUT} ${R_OUT} 0 0 1 ${x1.toFixed(2)} ${y1.toFixed(2)} L ${(R_OUT-40)*Math.cos(a1).toFixed(2)} ${(R_OUT-40)*Math.sin(a1).toFixed(2)} A ${R_OUT-40} ${R_OUT-40} 0 0 0 ${(R_OUT-40)*Math.cos(a0).toFixed(2)} ${(R_OUT-40)*Math.sin(a0).toFixed(2)} Z`);
  p.setAttribute('fill', n===0?'#0a9a4a':(REDS.has(n)?'#b72025':'#111')); p.setAttribute('stroke','#222'); p.setAttribute('stroke-width','1'); gNums.appendChild(p);
  const label=document.createElementNS('http://www.w3.org/2000/svg','text');
  const ang=(a0+a1)/2; label.setAttribute('x',(R_TEXT*Math.cos(ang)).toFixed(2)); label.setAttribute('y',(R_TEXT*Math.sin(ang)).toFixed(2));
  label.setAttribute('fill','#fff'); label.setAttribute('font-size','12'); label.setAttribute('text-anchor','middle'); label.setAttribute('dominant-baseline','middle'); label.textContent=String(n); gNums.appendChild(label);
  // aumentar ligeramente el tamaÃ±o del texto para legibilidad
  label.setAttribute('font-size','14');

});

/* ================== TABLERO ================== */
const layout=document.getElementById('layout'); const outsideMap=new Map(); const indexToCell={};
const zero = cell('0','zero'); 
zero.style.gridRow='1 / span 3'; 
zero.style.gridColumn='1 / 2'; 
layout.appendChild(zero);
indexToCell[0] = zero;
for(let r=0;r<3;r++){
  for(let c=0;c<12;c++){
    const n=3*c+(3-r);
    const col=REDS.has(n)?'red':'black';
    const d=cell(String(n),col);
    d.dataset.kind='straight';
    d.dataset.cover=JSON.stringify([n]);
    d.dataset.label=`${n}`;
    d.dataset.number=String(n);
    layout.appendChild(d);
    indexToCell[n]=d;
  }
}
const d1=outsideCell('1Âª Docena','dozen',ALL.filter(n=>n<=12)),
      d2=outsideCell('2Âª Docena','dozen',ALL.filter(n=>n>=13&&n<=24)),
      d3=outsideCell('3Âª Docena','dozen',ALL.filter(n=>n>=25));
d1.style.gridColumn='14 / 15'; d2.style.gridColumn='15 / 16'; d3.style.gridColumn='16 / 17';
d1.style.gridRow=d2.style.gridRow=d3.style.gridRow='1 / span 3';
layout.appendChild(d1); layout.appendChild(d2); layout.appendChild(d3);

const c1=outsideCell('Columna 1','column',ALL.filter(n=>n%3===1)),
      c2=outsideCell('Columna 2','column',ALL.filter(n=>n%3===2)),
      c3=outsideCell('Columna 3','column',ALL.filter(n=>n%3===0));
c1.style.gridColumn='2 / 14'; c1.style.gridRow='4 / 5';
c2.style.gridColumn='2 / 14'; c2.style.gridRow='5 / 6';
c3.style.gridColumn='2 / 14'; c3.style.gridRow='6 / 7';
layout.appendChild(c1); layout.appendChild(c2); layout.appendChild(c3);

const simpleRow=document.createElement('div');
simpleRow.style.gridColumn='14 / 17'; simpleRow.style.gridRow='4 / 7';
simpleRow.style.display='grid'; simpleRow.style.gridTemplateColumns='repeat(2, 1fr)'; simpleRow.style.gap='6px';
['Rojo','Negro','Par','Impar','1â€“18','19â€“36'].forEach(lbl=>{
  const map = {
    'Rojo':{kind:'even', set:ALL.filter(n=>REDS.has(n))},
    'Negro':{kind:'even', set:ALL.filter(n=>!REDS.has(n)&&n!==0)},
    'Par':{kind:'even', set:ALL.filter(n=>n%2===0&&n!==0)},
    'Impar':{kind:'even', set:ALL.filter(n=>n%2===1)},
    '1â€“18':{kind:'even', set:ALL.filter(n=>n>=1&&n<=18)},
    '19â€“36':{kind:'even', set:ALL.filter(n=>n>=19)}
  };
  const v=map[lbl];
  const el=outsideCell(lbl,v.kind,v.set); el.style.minHeight='48px'; simpleRow.appendChild(el);
});
layout.appendChild(simpleRow);

function cell(text, extra=''){ const d=document.createElement('div'); d.className=`cell ${extra}`.trim(); d.textContent=text; enableDrop(d); return d; }
function outsideCell(text, kind, set){ const d=cell(text,'outside'); d.dataset.kind=kind; d.dataset.cover=JSON.stringify(set); d.dataset.label=text; outsideMap.set(text,d); return d; }

/* ================== ARRÃSTRE & DETECCIÃ“N DE ZONA ================== */
function enableDrop(el){
    el.ondragover=(e)=>{e.preventDefault();
      // Mostrar previsualizaciÃ³n de la apuesta mientras arrastramos
      try{
        const rect=el.getBoundingClientRect();
        const x=(e.clientX-rect.left)/rect.width; const y=(e.clientY-rect.top)/rect.height;
        const num=Number(el.dataset.number||'0');
        const target = computeTargetFromPosition(num,x,y);
        clearPreview();
        if(target) highlightPreview(target);
      }catch(err){ /* ignore */ }
    };
    el.ondragleave = (e)=>{ clearPreview(); };
  el.ondrop=(e)=>{
    e.preventDefault(); droppedSomewhere=true;
    const kind=el.dataset.kind||'straight';
    const mv=e.dataTransfer.getData('chip_move'); const chipVal=e.dataTransfer.getData('chip');
    if(kind!=='straight'){
      const set=new Set(JSON.parse(el.dataset.cover||'[]'));
      const target={type:kind,set,label:el.dataset.label||el.textContent};
      if(mv){ const m=JSON.parse(mv); const from=findBetByKey(m.key); if(from){ transferChip(from,target,m.amount);} }
      else if(chipVal){ placeBet(target, Number(chipVal)); }
      return;
    }
    const rect=el.getBoundingClientRect();
    const x=(e.clientX-rect.left)/rect.width;
    const y=(e.clientY-rect.top)/rect.height;
    const num=Number(el.dataset.number||'0');
    const target = computeTargetFromPosition(num,x,y); if(!target) return;
    if(mv){ const m=JSON.parse(mv); const from=findBetByKey(m.key); if(from){ transferChip(from,target,m.amount);} }
    else if(chipVal){ placeBet(target, Number(chipVal)); }
  };
}

function getRC(n){ const c=Math.ceil(n/3)-1; const r=3-((n-1)%3)-1; return {r,c}; }
function numAt(r,c){ if(r<0||r>2||c<0||c>11) return null; return 3*c + (3-r); }

function computeTargetFromPosition(n,x,y){
  const {r,c}=getRC(n);

  // Hitbox thresholds
  const centerMin = 0.25, centerMax = 0.75; // center area -> single number
  const cornerThreshold = 0.18; // corner area -> 4 numbers

  // If pointer is squarely in the center area -> single number (straight)
  if(x >= centerMin && x <= centerMax && y >= centerMin && y <= centerMax){
    return {type:'straight', set:new Set([n]), label:String(n)};
  }

  // Corners (4 numbers) - top-left, top-right, bottom-left, bottom-right
  const nearLeftCorner = x < cornerThreshold, nearRightCorner = x > 1 - cornerThreshold;
  const nearTopCorner = y < cornerThreshold, nearBottomCorner = y > 1 - cornerThreshold;
  if(nearLeftCorner && nearTopCorner){ const a=n,b=numAt(r,c-1),c2=numAt(r-1,c),d=numAt(r-1,c-1); if(b&&c2&&d) return {type:'corner', set:new Set([a,b,c2,d]), label:`${a}-${b}-${c2}-${d}`}; }
  if(nearRightCorner && nearTopCorner){ const a=n,b=numAt(r,c+1),c2=numAt(r-1,c),d=numAt(r-1,c+1); if(b&&c2&&d) return {type:'corner', set:new Set([a,b,c2,d]), label:`${a}-${b}-${c2}-${d}`}; }
  if(nearLeftCorner && nearBottomCorner){ const a=n,b=numAt(r,c-1),c2=numAt(r+1,c),d=numAt(r+1,c-1); if(b&&c2&&d) return {type:'corner', set:new Set([a,b,c2,d]), label:`${a}-${b}-${c2}-${d}`}; }
  if(nearRightCorner && nearBottomCorner){ const a=n,b=numAt(r,c+1),c2=numAt(r+1,c),d=numAt(r+1,c+1); if(b&&c2&&d) return {type:'corner', set:new Set([a,b,c2,d]), label:`${a}-${b}-${c2}-${d}`}; }

  // Splits (2 numbers) - left/right/top/bottom middle bands
  const centerBandX = x >= centerMin && x <= centerMax;
  const centerBandY = y >= centerMin && y <= centerMax;
  if(x < centerMin && centerBandY){ const b = numAt(r, c-1); if(b) return {type:'split', set:new Set([n,b]), label:`${n}-${b}`}; }
  if(x > centerMax && centerBandY){ const b = numAt(r, c+1); if(b) return {type:'split', set:new Set([n,b]), label:`${n}-${b}`}; }
  if(y < centerMin && centerBandX){ const b = numAt(r-1, c); if(b) return {type:'split', set:new Set([n,b]), label:`${n}-${b}`}; }
  if(y > centerMax && centerBandX){ const b = numAt(r+1, c); if(b) return {type:'split', set:new Set([n,b]), label:`${n}-${b}`}; }

  // Streets (3 numbers) - if horizontally centered but above/below center area
  if(centerBandX && y < centerMin){ const a=numAt(0,c), b=numAt(1,c), d=numAt(2,c); if(a&&b&&d) return {type:'street', set:new Set([a,b,d]), label:`${a}-${b}-${d}`}; }
  if(centerBandX && y > centerMax){ const a=numAt(0,c), b=numAt(1,c), d=numAt(2,c); if(a&&b&&d) return {type:'street', set:new Set([a,b,d]), label:`${a}-${b}-${d}`}; }

  // Fallback: straight
  return {type:'straight', set:new Set([n]), label:String(n)};
}

// ====== PrevisualizaciÃ³n de apuesta durante arrastre ======
function clearPreview(){ document.querySelectorAll('.cell.preview').forEach(el=>el.classList.remove('preview')); }
function highlightPreview(target){ try{
  const nums = [...target.set]; nums.forEach(n=>{ const el = indexToCell[n]; if(el) el.classList.add('preview'); });
}catch(e){}
}

/* ================== CHIPS ================== */
const CHIP_COLORS=new Map([[20,'#ffd54f'],[50,'#4fc3f7'],[100,'#81c784'],[200,'#ba68c8'],[500,'#ff8a65'],[1000,'#e57373']]);
function pickChipColor(v){ if(CHIP_COLORS.has(v)) return CHIP_COLORS.get(v);
  if(v<50)return'#ffd54f'; if(v<100)return'#4fc3f7'; if(v<200)return'#81c784'; if(v<500)return'#ba68c8'; if(v<1000)return'#ff8a65'; return'#e57373';
}
function styleChips(){ document.querySelectorAll('.chip').forEach(ch=>{ const v=+ch.dataset.value||0; ch.style.background=pickChipColor(v); ch.style.color='#000'; }); }
function registerChip(chip){
  if(!chip) return;
  chip.addEventListener('click',()=>{ lastChipValue=Number(chip.dataset.value); flash(`Chip activa: ${centsToEuro(lastChipValue)}`); });
}
styleChips();

const chipsWrap=document.getElementById('chips'); let droppedSomewhere=false; let lastChipValue=50;
chipsWrap.addEventListener('dragstart', e=>{ const t=e.target.closest('.chip'); if(!t) return; droppedSomewhere=false; e.dataTransfer.setData('chip', t.dataset.value); });
document.body.addEventListener('dragend', ()=>{ if(!droppedSomewhere) flash('Ficha no colocada'); });
document.body.addEventListener('dragend', ()=>{ clearPreview(); });
document.querySelectorAll('.chip').forEach(registerChip);

const customChipInput=document.getElementById('customChip');
const addChipButton=document.getElementById('addChip');
function createCustomChip(amount){
  const chip=document.createElement('div');
  chip.className='chip custom-chip';
  chip.draggable=true;
  chip.dataset.value=String(amount);
  chip.textContent=centsToEuro(amount);
  chipsWrap.appendChild(chip);
  registerChip(chip);
  styleChips();
  lastChipValue=amount;
}
if(addChipButton){
  addChipButton.addEventListener('click',()=>{
    if(!customChipInput) return;
    let amount = Number(customChipInput.value);
    if(!Number.isFinite(amount)){ flash('Introduce un valor vÃ¡lido'); return; }
    amount = Math.round(amount);
    if(amount < 20){ flash('La ficha mÃ­nima es 20Â¢'); return; }
    createCustomChip(amount);
    flash(`Ficha personalizada de ${centsToEuro(amount)} lista para usar`);
  });
}

/* ================== EXTERIORES Y ESPECIALES ================== */
document.querySelectorAll('[data-out]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const map={
      red:{type:'even', set:ALL.filter(n=>REDS.has(n)), label:'Rojo'},
      black:{type:'even', set:ALL.filter(n=>!REDS.has(n)&&n!==0), label:'Negro'},
      even:{type:'even', set:ALL.filter(n=>n%2===0&&n!==0), label:'Par'},
      odd:{type:'even', set:ALL.filter(n=>n%2===1), label:'Impar'},
      low:{type:'even', set:ALL.filter(n=>n>=1&&n<=18), label:'1â€“18'},
      high:{type:'even', set:ALL.filter(n=>n>=19), label:'19â€“36'},
      d1:{type:'dozen', set:ALL.filter(n=>n<=12), label:'1Âª Docena'},
      d2:{type:'dozen', set:ALL.filter(n=>n>=13&&n<=24), label:'2Âª Docena'},
      d3:{type:'dozen', set:ALL.filter(n=>n>=25), label:'3Âª Docena'},
      c1:{type:'column', set:ALL.filter(n=>n%3===1), label:'Columna 1'},
      c2:{type:'column', set:ALL.filter(n=>n%3===2), label:'Columna 2'},
      c3:{type:'column', set:ALL.filter(n=>n%3===0), label:'Columna 3'}
    };
    const {type,set,label}=map[btn.dataset.out];
    placeBet({type, set:new Set(set), label}, currentChipValue());
  });
});

const SPECIALS={ voisins:[22,18,29,7,28,12,35,3,26,0,32,15,19,4,21,2,25], tiers:[27,13,36,11,30,8,23,10,5,24,16,33], orphelins:[1,20,14,31,9,6,34,17] };
document.getElementById('voisinsBtn').onclick=()=>massBet(SPECIALS.voisins);
document.getElementById('tiersBtn').onclick=()=>massBet(SPECIALS.tiers);
document.getElementById('orphBtn').onclick=()=>massBet(SPECIALS.orphelins);
function massBet(list){
  const amount=currentChipValue(); const need=amount*list.length;
  if(bank<need) return flash(`Fondos insuficientes (${centsToEuro(need)})`);
  list.forEach(n=> placeBet({type:'straight', set:new Set([n]), label:String(n)}, amount, true));
  showVisuals(); updateTotals();
}

/* ================== GESTIÃ“N DE APUESTAS ================== */
function currentChipValue(){ return lastChipValue ?? 50; }
function betKey(obj){ const key=(s)=>[...s].sort((a,b)=>a-b).join('-'); return `${obj.type}:${key(obj.set)}`; }
function findBetByKey(keyStr){ return bets.find(b=> betKey(b)===keyStr); }

function placeBet(target, amount, silent=false){
  if(amount<=0) return;
  if(amount<20){ flash('Apuesta mÃ­nima por casilla: 20Â¢'); return; }
  if(bank<amount){ flash('Fondos insuficientes'); return; }

  bank -= amount;
  const key=(s)=>[...s].sort((a,b)=>a-b).join('-');
  const k=key(target.set);
  const idx=bets.findIndex(b=> b.type===target.type && key(b.set)===k);
  if(idx>=0){
    bets[idx].amount += amount;
    bets[idx].maxChip = Math.max(bets[idx].maxChip||0, amount);
    (bets[idx].chips||=[]).push(amount);
  } else {
    bets.push({type:target.type, set:new Set(target.set), amount, label:target.label, maxChip:amount, chips:[amount]});
  }
  history.push({type:'bet', payload:{...target, amount}});
  showVisuals(); updateTotals();
  if(!silent) flash(`Apuestas ${centsToEuro(amount)} a ${target.label}`);
}

function cloneBets(arr){ return arr.map(b=>({type:b.type,set:new Set(b.set),amount:b.amount,label:b.label,maxChip:b.maxChip,chips:[...(b.chips||[])]})); }

function transferChip(fromBet, target, amount){
  const idx = fromBet.chips ? fromBet.chips.lastIndexOf(amount) : -1; if(idx<0) return;
  fromBet.chips.splice(idx,1); fromBet.amount -= amount;
  if(fromBet.amount<=0){ const i=bets.indexOf(fromBet); if(i>=0) bets.splice(i,1); }
  else { fromBet.maxChip = fromBet.chips.length? Math.max(...fromBet.chips):0; }

  const key=(s)=>[...s].sort((a,b)=>a-b).join('-'); const k=key(target.set);
  const j=bets.findIndex(b=> b.type===target.type && key(b.set)===k);
  if(j>=0){ bets[j].amount += amount; (bets[j].chips||=[]).push(amount); bets[j].maxChip=Math.max(bets[j].maxChip||0, amount); }
  else { bets.push({type:target.type,set:new Set(target.set),amount:amount,label:target.label,maxChip:amount,chips:[amount]}); }
  showVisuals(); updateTotals();
}

/* ================== RENDER DE FICHAS ================== */
function ensureBadge(el){
  if(!el) return {badge:null,dot:null,stack:null};
  let badge=el.querySelector('.bet-badge'); if(!badge){ badge=document.createElement('div'); badge.className='bet-badge'; el.appendChild(badge);}
  let dot=el.querySelector('.color-dot'); if(!dot){ dot=document.createElement('div'); dot.className='color-dot'; el.appendChild(dot);}
  let stack=el.querySelector('.stack'); if(!stack){ stack=document.createElement('div'); stack.className='stack'; el.appendChild(stack);}
  return {badge,dot,stack};
}
function renderStack(container, chips, key){
  container.innerHTML='';
  const maxShow=6; const show=chips.slice(-maxShow); const baseOffset=3;
  show.forEach((v,i)=>{
    const c=document.createElement('div'); c.className='mini-chip';
    c.style.background=pickChipColor(v); c.style.transform=`translate(${-i*baseOffset}px, ${-i*baseOffset}px)`;
    c.draggable=true; c.dataset.move = JSON.stringify({key, amount:v});
    c.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('chip_move', c.dataset.move); e.dataTransfer.effectAllowed='move'; });
    container.appendChild(c);
  });
  if(chips.length>maxShow){
    const more=document.createElement('div'); more.className='mini-chip';
    more.style.background='#fff'; more.style.transform=`translate(${-maxShow*baseOffset}px, ${-maxShow*baseOffset}px)`; more.style.fontSize='9px';
    more.textContent='+'+(chips.length-maxShow); container.appendChild(more);
  }
}
function anchorElForBet(b){
  if(b.type==='straight'&&b.set.size===1){ return indexToCell[[...b.set][0]]; }
  if(b.type==='dozen'||b.type==='column'||b.type==='even'){ return outsideMap.get(b.label); }
  const nums=[...b.set].sort((a,b)=>a-b);
  return indexToCell[nums[0]];
}
function showVisuals(){
  document.querySelectorAll('.bet-badge,.color-dot,.stack').forEach(n=>n.remove());
  bets.forEach(b=>{
    const el=anchorElForBet(b); if(!el) return;
    const color=pickChipColor(b.maxChip||0);
    const {badge,dot,stack}=ensureBadge(el);
    if(badge){ badge.textContent=centsToEuro(b.amount); }
    if(dot){ dot.style.background=color; }
    if(stack){ renderStack(stack, b.chips||[], betKey(b)); }
  });
}

/* ================== TOTALES Y CONTROLES ================== */
function totalStake(){ return bets.reduce((a,b)=>a+b.amount,0); }
function updateTotals(){ betTotalEl.textContent = centsToEuro(totalStake()); bankEl.textContent = centsToEuro(bank); }
function clearBets(){ const refund=totalStake(); bank+=refund; bets=[]; updateTotals(); showVisuals(); flash(`Borras jugada (${centsToEuro(refund)})`); history.push({type:'clear',amount:refund}); }
document.getElementById('clearBtn').onclick=clearBets;

document.getElementById('undoBtn').onclick=()=>{
  const act=history.pop(); if(!act) return;
  if(act.type==='bet'){
    const {type,set,label,amount}=act.payload;
    const key=(s)=>[...s].sort((a,b)=>a-b).join('-'); const k=key(set);
    const idx=bets.findIndex(b=>b.type===type && key(b.set)===k);
    if(idx>=0){
      bets[idx].amount-=amount;
      if(bets[idx].chips){ const i=bets[idx].chips.lastIndexOf(amount); if(i>=0) bets[idx].chips.splice(i,1); }
      if(bets[idx].amount<=0) bets.splice(idx,1);
    }
    bank+=amount; showVisuals(); updateTotals(); flash(`Deshaces ${centsToEuro(amount)} en ${label}`);
  } else if(act.type==='clear'){
    const amt=Math.min(bank, act.amount); bank-=amt; updateTotals(); flash('Deshacer de borrar (no exacto)');
  }
};

document.getElementById('dupBtn').onclick=()=>{
  const need=totalStake(); if(need===0) return flash('Nada que duplicar.');
  if(bank<need) return flash('Fondos insuficientes para duplicar.');
  lastBets=cloneBets(bets);
  bets.forEach(b=>{
    bank-=b.amount;
    b.chips=[...b.chips,...b.chips];
    b.amount+=b.amount;
    b.maxChip=Math.max(b.maxChip||0,...b.chips);
  });
  updateTotals(); showVisuals(); flash('Apuestas duplicadas');
};

document.getElementById('repeatBtn').onclick=()=>{
  if(lastBets.length===0) return flash('Sin Ãºltima jugada.');
  const need=lastBets.reduce((a,b)=>a+b.amount,0);
  if(bank<need) return flash('Fondos insuficientes.');
  bets=cloneBets(lastBets); bank-=need; updateTotals(); showVisuals(); flash('Ãšltima jugada colocada');
};

/* ================== GIRO Y LIQUIDACIÃ“N ================== */
function setMode(mode){ document.body.setAttribute('data-mode', mode); }

document.getElementById('spinBtn').onclick = async () => {
  if (spinning) return;
  if (bets.length === 0) { flash('Pon al menos una apuesta.'); return; }

  const placedBetsSnapshot = bets.map(b => ({
    type: b.type, set: [...b.set], label: b.label, amount: b.amount
  }));

  // 1) Enviar las apuestas y actualizar balance local (place)
  try{
    const placed = await apiPOST('/api/ruleta/place', { bets: placedBetsSnapshot, min_cell: 20 });
    bank = placed.balance; updateTotals();
  }catch(e){ flash('Error al colocar apuestas'); return; }

  // 2) Pedir al servidor que haga el giro y nos devuelva el nÃºmero ganador
  let spinResp;
  try{
    spinResp = await apiPOST('/api/ruleta/spin', { bets: placedBetsSnapshot });
  }catch(e){ flash('Error al girar la ruleta'); return; }

  // Resultado provisto por el servidor
  let resultNumber = spinResp && typeof spinResp.result !== 'undefined' ? spinResp.result : null;
  let resultIdx = (resultNumber !== null) ? EURO_SEQ.indexOf(resultNumber) : -1;
  if (resultIdx < 0) resultIdx = Math.floor(Math.random() * EURO_SEQ.length);

  // 3) Animar hacia el pocket que corresponde al nÃºmero devuelto por el servidor
  spinning = true; setMode('spin');
  document.getElementById('spinBtn').disabled = true;

  if (instantMode) {
    alignToPocket(resultIdx);
  } else {
    await spinAnimTo(resultIdx);
  }

  // 4) Actualizar UI con la respuesta del servidor (ya incluye balance y estadÃ­sticas)
  try{
    bank = spinResp.balance; updateTotals();
    if (spinResp.stats) renderStats(spinResp.stats);
    if (spinResp.mensaje) log(spinResp.mensaje);
    else log(`<b>Sale ${resultNumber}</b>`);
  }catch(e){ /* no-fatal */ }

  // Sistema de mensajes motivacionales - determinar si ganÃ³ o perdiÃ³
  const apuestaTotal = placedBetsSnapshot.reduce((sum, bet) => sum + bet.amount, 0);
  const resultado = (spinResp.balance > bank) ? 'ganada' : 'perdida';
  checkMotivationalMessage(resultado);
  // Limpieza local (las apuestas ya han sido procesadas por el servidor)
  lastBets = cloneBets(bets);
  bets = [];
  showVisuals(); updateTotals();
  spinning = false;
  document.getElementById('spinBtn').disabled = false;
  setMode('bet');
};

function spinAnimTo(resultIdx){
  return new Promise(resolve=>{
      const start=performance.now();
      // Obtener rotaciÃ³n actual de la rueda (si ya estÃ¡ alineada por una jugada
      // previa) para que la animaciÃ³n sea continua y el final coincida con lo
      // calculado. Si no hay transform, usar valor aleatorio.
      let baseWheel = 0;
      try{
        const cur = gNums.getAttribute('transform')||'';
        const m = cur.match(/rotate\((-?\d+(?:\.\d+)?)\)/);
        if(m && m[1]) baseWheel = parseFloat(m[1]); else baseWheel = Math.random()*360;
      }catch(e){ baseWheel = Math.random()*360; }

      // Calculamos el Ã¡ngulo final exacto para que el pocket centrado sea el
      // correspondiente a resultIdx. Usamos (idx + 0.5) para apuntar al centro
      // de la casilla. DespuÃ©s garantizamos varias vueltas completas antes de
      // aterrizar en ese Ã¡ngulo para una animaciÃ³n natural.
      const per = 360 / EURO_SEQ.length;
      const desiredFinal = -((resultIdx + 0.5) * per); // grados

      // DuraciÃ³n y giros: dejamos varias vueltas completas (e.g., 5) y aÃ±adimos
      // el delta necesario para acabar exactamente en desiredFinal desde baseWheel.
      const fullTurns = 5; // nÃºmero de vueltas completas
      const baseNorm = ((baseWheel % 360) + 360) % 360;
      const delta = ((desiredFinal - baseNorm) % 360 + 360) % 360;
      const spinWheel = 360 * fullTurns + delta;

      const spinBall = 3000+Math.random()*1200;
      const duration=5200+Math.random()*1000;
    function easeOutQuint(t){ return 1-Math.pow(1-t,5); }
    function frame(now){
      const t=Math.min(1,(now-start)/duration);
      const wheelAngle=baseWheel+easeOutQuint(t)*spinWheel;
      gNums.setAttribute('transform',`rotate(${wheelAngle})`);
      const wobble=(1-t)*6*Math.sin(now/80)+(1-t)*3*Math.sin(now/43);
      const ballAngle=-(easeOutQuint(t)*spinBall)+wobble;
      const rad=(ballAngle-90)*Math.PI/180; const r=170-30*easeOutQuint(t)+2*Math.sin(now/60);
      ball.setAttribute('cx',(r*Math.cos(rad)).toFixed(2)); ball.setAttribute('cy',(r*Math.sin(rad)).toFixed(2));
      if(t<1){ requestAnimationFrame(frame); } else { alignToPocket(resultIdx); resolve(); }
    }
    requestAnimationFrame(frame);
  });
}

function alignToPocket(resultIdx){
  const per = 360 / EURO_SEQ.length;
  // Para centrar la casilla usamos el punto medio: (idx + 0.5)
  const finalWheel = -((resultIdx + 0.5) * per);
  gNums.setAttribute('transform', `rotate(${finalWheel})`);

  // La bola debe quedar ligeramente antes del centro (pequeÃ±o offset)
  const finalBallAng = -90 - 4; // en grados: top (-90) menos un pequeÃ±o ajuste
  const r2 = 150; const rad2 = finalBallAng * Math.PI / 180;
  ball.setAttribute('cx', (r2 * Math.cos(rad2)).toFixed(2));
  ball.setAttribute('cy', (r2 * Math.sin(rad2)).toFixed(2));
}

function settle(number){
  const totalStaked = totalStake();
  const before = bank;
  let returned = 0, win = 0;

  for (const b of bets){
    if (b.set.has(number)){
      const mult = PAYOUT[b.type] ?? 0;
      win      += b.amount * mult;
      returned += b.amount;
    }
  }

  bank += returned + win;

  log(`<b>Sale ${number}</b>. Apostado: ${centsToEuro(totalStaked)}.
      Premio: ${centsToEuro(win)}${returned ? ' + devoluciÃ³n ' + centsToEuro(returned) : ''}.
      Banco: ${centsToEuro(bank)}. Î” ${centsToEuro(bank-before)}`);

  lastBets = cloneBets(bets);
  bets = [];
  showVisuals();
  updateTotals();
  spinning = false;
  document.getElementById('spinBtn').disabled = false;
  setMode('bet');
}

/* ================== MINI PRUEBA ================== */
(function smoke(){
  try{
    console.assert(PAYOUT.straight===35 && PAYOUT.column===2 && PAYOUT.even===1, 'PAYOUT ok');
  }catch(e){ console.warn('Test PAYOUT:', e.message); }
})();

let _ruletaPoll = setInterval(()=>refreshState(), 5000);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refreshState(); });
</script>

<style>
/* Reaprovechar botones neon en pÃ¡ginas legacy */
.btn-neon {
  background: var(--gradient-cyber);
  color: #050511;
  border: none;
  box-shadow: var(--glow-cyan-button);
}

.btn-neon:hover {
  background: var(--gradient-sunset);
  color: #050511;
  box-shadow: var(--glow-multi-button);
}

.ruleta-legacy .btn-neon {
  background: var(--gradient-cyber) !important;
  color: #050511 !important;
  border: none !important;
  box-shadow: var(--glow-cyan-button) !important;
}

.ruleta-legacy .btn-neon:hover {
  background: var(--gradient-sunset) !important;
  color: #050511 !important;
  box-shadow: var(--glow-multi-button) !important;
}

.btn-neon-secondary {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: var(--text-light);
  box-shadow: none;
}

.ruleta-legacy .btn-neon-secondary {
  background: rgba(255, 255, 255, 0.08) !important;
  border: 1px solid rgba(255, 255, 255, 0.2) !important;
  color: var(--text-light) !important;
  box-shadow: none !important;
}

/* === RULETA SINGLEPLAYER === */
.ruleta-breakout {
  width: 100vw;
  margin-left: calc(50% - 50vw);
  padding: 0 clamp(1.5rem, 4vw, 5rem);
  box-sizing: border-box;
}

.ruleta-page {
  --ruleta-felt: #1a2240;
  --ruleta-felt-dark: #151b34;
  --ruleta-gold: #e0b14a;
  --ruleta-tile: #202a55;
  --ruleta-tile-outer: #1e264c;
  --ruleta-badge-bg: rgba(255, 255, 255, 0.92);
  --ruleta-badge-fg: #10121f;
  background: rgba(10, 12, 25, 0.7);
  border: 1px solid rgba(0, 243, 255, 0.2);
  border-radius: 32px;
  padding: clamp(1.5rem, 2vw, 3rem);
  box-shadow: 0 25px 65px rgba(2, 8, 20, 0.6);
  width: min(1800px, 100%);
  margin: 0 auto;
}

.ruleta-header {
  background: rgba(15, 18, 32, 0.92);
  border-radius: 24px;
  padding: 1.75rem;
  border: 1px solid rgba(0, 243, 255, 0.18);
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: center;
  box-shadow: var(--shadow-hologram);
}

.ruleta-heading {
  font-family: var(--font-family-title);
  font-weight: 700;
  letter-spacing: 0.05em;
}

.ruleta-section-label {
  letter-spacing: 0.25em;
  font-size: 0.85rem;
}

.ruleta-header .balances {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  align-items: center;
}

.ruleta-header .pill,
.ruleta-ui .pill {
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(0, 243, 255, 0.25);
  padding: 0.45rem 0.9rem;
  border-radius: 999px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
}

.ruleta-ui .pill-toggle input {
  accent-color: var(--neon-cyan);
}

.ruleta-ui .pill-inline {
  gap: 0.5rem;
  display: inline-flex;
  align-items: center;
}

.ruleta-ui {
  margin-top: 1.5rem;
  width: 100%;
}

.ruleta-ui .panel {
  background: linear-gradient(180deg, var(--ruleta-felt), var(--ruleta-felt-dark));
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 24px;
  padding: 1.5rem;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
}

.ruleta-ui .wheel-wrap {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  align-items: center;
}

.ruleta-grid {
  display: grid;
  grid-template-columns: minmax(360px, 450px) minmax(0, 1fr);
  gap: clamp(1.5rem, 2vw, 2.5rem);
  align-items: flex-start;
}

.ruleta-grid-multi {
  display: grid;
  grid-template-columns: minmax(360px, 440px) minmax(620px, 1fr) minmax(260px, 320px);
  gap: clamp(1.1rem, 1.6vw, 2rem);
  align-items: flex-start;
}

.ruleta-panel-table {
  min-width: 0;
  width: 100%;
}

.ruleta-ui .wheel-wrap svg {
  width: 100%;
  max-width: 460px;
  height: auto;
}

.ruleta-ui .controls {
  display: flex;
  flex-wrap: wrap;
  gap: 0.65rem;
  justify-content: center;
}

.ruleta-ui .controls .btn,
.ruleta-ui .bets-buttons .btn,
.ruleta-ui #addChip {
  border: none;
  border-radius: 12px;
  padding: 0.65rem 1rem;
  font-weight: 700;
  background: var(--gradient-cyber);
  color: #050511;
  box-shadow: var(--glow-cyan-button);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.ruleta-ui .controls .btn.secondary,
.ruleta-ui .bets-buttons .btn.secondary,
.ruleta-ui #addChip.secondary {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  color: var(--text-light);
  box-shadow: none;
}

.ruleta-ui .controls .btn:hover,
.ruleta-ui .bets-buttons .btn:hover,
.ruleta-ui #addChip:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(0, 243, 255, 0.35);
}

.ruleta-ui .controls .btn:active,
.ruleta-ui .bets-buttons .btn:active,
.ruleta-ui #addChip:active {
  transform: translateY(0);
}

.ruleta-ui .chips {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  align-items: center;
  padding: 0.75rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 18px;
  margin-bottom: 1rem;
}

.ruleta-ui #customChip {
  width: 6em;
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: var(--text-light);
  padding: 0.35rem 0.5rem;
}

.ruleta-ui .bets-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.65rem;
  margin: 0.5rem 0 1rem;
}

.ruleta-ui .table {
  display: grid;
  grid-template-columns: 90px repeat(12, 1fr) 140px 140px;
  gap: 5px;
  padding: 12px;
  background: var(--ruleta-felt);
  border-radius: 18px;
  border: 1px solid rgba(255, 255, 255, 0.15);
  overflow-x: auto;
  min-width: 1200px;
  max-width: 100%;
}

.ruleta-ui .cell {
  position: relative;
  background: var(--ruleta-tile);
  border: 1px solid rgba(0, 0, 0, 0.35);
  color: #fafafa;
  text-align: center;
  padding: 22px 8px;
  border-radius: 10px;
  user-select: none;
  font-size: 1.5rem;
  font-weight: 900;
  white-space: nowrap;
  word-break: keep-all;
  writing-mode: horizontal-tb;
}

.ruleta-ui .cell.zero {
  background: #1d6f3e;
  display: flex;
  align-items: center;
  justify-content: center;
}

.ruleta-ui .cell.red {
  background: #9e1f24;
}

.ruleta-ui .cell.black {
  background: #0b0b0b;
}

.ruleta-ui .cell.preview {
  outline: 3px solid rgba(255, 215, 0, 0.85);
  box-shadow: 0 6px 18px rgba(255, 215, 0, 0.2);
}

.ruleta-ui .outside {
  background: var(--ruleta-tile-outer);
  font-weight: 800;
  font-size: 1.1rem;
}

.ruleta-ui .bet-badge {
  position: absolute;
  right: 8px;
  bottom: 8px;
  background: var(--ruleta-badge-bg);
  color: var(--ruleta-badge-fg);
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 0.8rem;
  font-weight: 900;
}

.ruleta-ui .color-dot {
  position: absolute;
  left: 8px;
  bottom: 8px;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 2px solid rgba(0, 0, 0, 0.45);
  box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.25);
}

.ruleta-ui .stack {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  pointer-events: auto;
}

.ruleta-ui .mini-chip {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 3px dotted rgba(0, 0, 0, 0.35);
  display: grid;
  place-items: center;
  font-size: 0.65rem;
  font-weight: 900;
  color: #000;
  position: absolute;
  left: 0;
  top: 0;
}

.ruleta-ui .chip {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-weight: 900;
  border: 6px dotted rgba(0, 0, 0, 0.25);
  cursor: grab;
  color: #000;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
}

.ruleta-ui .group {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 18px;
  padding: 1.25rem;
}

.ruleta-ui .group-title {
  margin-bottom: 1rem;
  font-family: var(--font-family-title);
  letter-spacing: 0.05em;
}

.ruleta-ui .log {
  height: 220px;
  overflow: auto;
  background: #0f1535;
  color: #eafdf0;
  padding: 1rem;
  border-radius: 12px;
  font-family: ui-monospace, Consolas, monospace;
  border: 1px solid rgba(255, 255, 255, 0.08);
}

.chat-row {
  display: flex;
  gap: 0.65rem;
  align-items: center;
}

.chat-row input {
  flex: 1;
  background: rgba(0, 0, 0, 0.25);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--text-light);
  border-radius: 10px;
  padding: 0.55rem 0.75rem;
}

.side-panel {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  min-width: 260px;
}

.players-list {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 0.75rem;
  max-height: 180px;
  overflow: auto;
  font-size: 0.9rem;
}

.stats-panel .stat-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.stats-panel .stat-row:last-child {
  border-bottom: none;
}

.recent-bets {
  max-height: 140px;
  overflow: auto;
}

.color-swatch {
  display: inline-block;
  width: 16px;
  height: 16px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.5);
  margin-left: 8px;
  vertical-align: middle;
}

.color-picker {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.color-btn {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
}

.color-btn.selected {
  border-color: white;
  box-shadow: 0 0 8px rgba(255,255,255,0.5);
}

.color-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.ruleta-grid-multi > .side-panel {
  grid-column: 3;
}

.ruleta-note {
  letter-spacing: 0.08em;
}

@media (max-width: 991.98px) {
  .ruleta-page {
    padding: 1.25rem;
  }

  .ruleta-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .ruleta-header .balances {
    width: 100%;
    margin-left: 0;
  }

  .ruleta-grid {
    grid-template-columns: 1fr;
  }

  .ruleta-grid-multi {
    grid-template-columns: 1fr;
  }

  .ruleta-grid-multi > .side-panel {
    grid-column: 1;
  }

  .ruleta-breakout {
    width: 100%;
    margin-left: 0;
    padding: 0 1rem;
  }

  .ruleta-ui .table {
    min-width: 900px;
  }
}

@media (max-width: 1400px) {
  .ruleta-grid-multi {
    grid-template-columns: minmax(340px, 420px) minmax(540px, 1fr);
  }

  .ruleta-grid-multi > .side-panel {
    grid-column: 1 / -1;
  }
}
</style>
{% endblock %}
