{% extends "pages/casino/juegos/base.html" %}

{% block title %}
Coinflip (multijugador)
{% endblock %}

{% block game_title %}
Coinflip
{% endblock %}

{% block content_fluid %}
<!-- Moneda -->
<div class="row">
    <div class="fluid-content">
        <div class="coin-wrapper" style="margin-top: 2.5rem; margin-bottom: 2.5rem;">
            <div id="moneda-multijugador" class="coin">
                <div class="face front">
                    <div class="face-inner">
                        <div class="emoji">ü™ô</div>
                        <div class="label">CARA</div>
                    </div>
                </div>
                <div class="face back">
                    <div class="face-inner">
                        <div class="emoji">üåø</div>
                        <div class="label">CRUZ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row mt-4">
    <!-- Panel de Juego -->
    <div class="col-12">
        <div id="estado-juego" class="text-center">
            <div class="alert alert-info">
                Esperando apuestas...
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-gamepad me-2"></i>Juego
            </div>
            <div class="card-body text-center">                
                <!-- Controles de Apuesta -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Cantidad</label>
                        <input type="number" id="cantidad-apuesta" class="form-control" 
                                min="{{ sala.apuesta_minima }}" value="{{ sala.apuesta_minima }}">
                        <small class="text-muted">Tu balance: $<span id="balance-usuario">{{ "%.2f"|format(current_user.balance) }}</span></small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Elecci√≥n</label>
                        <div>
                            <button id="btn-elegir-cara" class="btn btn-outline-danger me-2" 
                                    onclick="elegirLado('cara')">
                                <i class="fas fa-crown me-1"></i>Cara
                            </button>
                            <button id="btn-elegir-cruz" class="btn btn-outline-success" 
                                    onclick="elegirLado('cruz')">
                                <i class="fas fa-leaf me-1"></i>Cruz
                            </button>
                        </div>
                        <small id="eleccion-actual" class="text-muted mt-1 d-block">No has elegido</small>
                    </div>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="d-flex gap-2 justify-content-center">
                    <button id="btn-apostar" class="btn btn-lg btn-primary" onclick="realizarApuesta()">
                        <i class="fas fa-coins me-1"></i>Apostar
                    </button>
                    {% if sala.creador_id == current_user.id %}
                    <button id="btn-lanzar" class="btn btn-lg btn-success" onclick="lanzarMoneda()" disabled>
                        <i class="fas fa-rocket me-1"></i>Lanzar Moneda
                    </button>
                    {% endif %}
                    <button id="btn-reiniciar" class="btn btn-outline-secondary" onclick="reiniciarApuesta()" style="display: none;">
                        <i class="fas fa-redo me-1"></i>Nueva Apuesta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Apuestas Actuales -->
    <div class="col-12 col-md-7">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-list me-2"></i>Apuestas Actuales 
                <span class="badge bg-primary" id="contador-apuestas">0</span>
            </div>
            <div class="card-body">
                <div id="lista-apuestas">
                    <div class="text-center text-muted">No hay apuestas a√∫n</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Eventos -->
    <div class="col-12 col-md-5">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-comments me-2"></i>Eventos
            </div>
            <div class="card-body">
                <div id="event-messages">
                    <div class="text-center text-muted">No hay eventos</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const salaId = {{ sala.id }};
const esCreador = {{ 'true' if sala.creador_id == current_user.id else 'false' }};
const socket = io();

console.log(`üéÆ Inicializando CoinFlip Multijugador:
- Sala ID: ${salaId}
- Es Creador: ${esCreador}
- Usuario: {{ current_user.username }}`);

let ladoElegido = null;
let apuestasActuales = [];
let jugadoresConectados = [];
let yaAposte = false;

document.addEventListener('DOMContentLoaded', function() {
    console.log(`üîó Conectando a sala CoinFlip ${salaId}`);
    
    // Unirse a la sala de CoinFlip
    socket.emit('join_coinflip_room', { sala_id: salaId });
    
    // Verificar conexi√≥n
    socket.on('connect', () => {
        console.log('‚úÖ Conectado al servidor SocketIO');
    });
    
    socket.on('disconnect', () => {
        console.log('‚ùå Desconectado del servidor SocketIO');
    });
});

// Socket Events - CON M√ÅS DEBUG
socket.on('estado_sala_actualizado', (data) => {
    console.log('üîÑ Estado actualizado recibido:', data);
    jugadoresConectados = data.jugadores || [];
    apuestasActuales = data.apuestas || [];
    
    actualizarApuestas();
    actualizarContadores();
    actualizarBotones();
});

socket.on('nueva_apuesta_coinflip', (data) => {
    console.log('üí∞ Nueva apuesta recibida:', data);
    
    // Actualizar lista de apuestas
    const apuestaExistente = apuestasActuales.find(a => a.usuario_id === data.usuario_id);
    if (apuestaExistente) {
        Object.assign(apuestaExistente, data);
    } else {
        apuestasActuales.push(data);
    }
    
    actualizarApuestas();
    actualizarContadores();
    actualizarBotones();
    
    if (data.usuario_id !== {{ current_user.id }}) {
        agregarEvento(`${data.username} apost√≥ $${data.cantidad} por ${data.eleccion}`);
    }
});

socket.on('moneda_lanzada', (data) => {
    console.log('üéØ Moneda lanzada recibida:', data);
    document.getElementById('estado-juego').innerHTML = `
        <div class="alert alert-warning">
            <strong>¬°Moneda en el aire!</strong><br>
            Lanzada por: ${data.lanzador}<br>
            <small>Resultado en 3 segundos...</small>
        </div>
    `;
    
    // Animaci√≥n de la moneda
    mostrarAnimacionMoneda(data.resultado);
});

socket.on('resultados_finales_coinflip', (data) => {
    console.log('üèÅ Resultados finales recibidos:', data);
    mostrarResultadosFinales(data);
});

// Manejar errores
socket.on('error_apuesta', (data) => {
    console.log('‚ùå Error en apuesta:', data);
    alert(`Error: ${data.message}`);
});

socket.on('error_lanzamiento', (data) => {
    console.log('‚ùå Error en lanzamiento:', data);
    alert(`Error: ${data.message}`);
    // Rehabilitar bot√≥n de lanzar
    if (esCreador) {
        document.getElementById('btn-lanzar').disabled = false;
        document.getElementById('btn-lanzar').innerHTML = '<i class="fas fa-rocket me-1"></i>Lanzar Moneda';
    }
});

// Funciones del juego - ACTUALIZADAS
function elegirLado(lado) {
    if (yaAposte) {
        alert('Ya has apostado en esta ronda. Espera al siguiente lanzamiento.');
        return;
    }
    
    ladoElegido = lado;
    document.getElementById('btn-elegir-cara').classList.toggle('btn-danger', lado === 'cara');
    document.getElementById('btn-elegir-cara').classList.toggle('btn-outline-danger', lado !== 'cara');
    document.getElementById('btn-elegir-cruz').classList.toggle('btn-success', lado === 'cruz');
    document.getElementById('btn-elegir-cruz').classList.toggle('btn-outline-success', lado !== 'cruz');
    
    document.getElementById('eleccion-actual').textContent = `Elegido: ${lado.toUpperCase()}`;
    document.getElementById('eleccion-actual').className = `text-${lado === 'cara' ? 'danger' : 'success'} mt-1 d-block`;
}

function realizarApuesta() {
    if (!ladoElegido) {
        alert('Selecciona cara o cruz primero');
        return;
    }
    
    if (yaAposte) {
        alert('Ya has apostado en esta ronda');
        return;
    }
    
    const cantidad = parseFloat(document.getElementById('cantidad-apuesta').value);
    const balance = parseFloat(document.getElementById('balance-usuario').textContent);
    
    if (cantidad < {{ sala.apuesta_minima }}) {
        alert(`La apuesta m√≠nima es ${{ sala.apuesta_minima }}`);
        return;
    }
    
    if (cantidad > balance) {
        alert('Fondos insuficientes');
        return;
    }
    
    console.log('üì§ Enviando apuesta:', { sala_id: salaId, cantidad, eleccion: ladoElegido });
    
    // Enviar apuesta via SocketIO
    socket.emit('coinflip_apostar', {
        sala_id: salaId,
        cantidad: cantidad,
        eleccion: ladoElegido
    });
    
    yaAposte = true;
    document.getElementById('btn-apostar').disabled = true;
    document.getElementById('btn-apostar').innerHTML = '<i class="fas fa-check me-1"></i>Apuesta Realizada';
    
    // Actualizar balance localmente
    document.getElementById('balance-usuario').textContent = (balance - cantidad).toFixed(2);
}

function lanzarMoneda() {
    if (!esCreador) return;
    
    if (apuestasActuales.length === 0) {
        alert('No hay apuestas para lanzar la moneda');
        return;
    }
    
    console.log('üì§ Enviando lanzamiento de moneda...');
    
    socket.emit('coinflip_lanzar', {
        sala_id: salaId
    });
    
    document.getElementById('btn-lanzar').disabled = true;
    document.getElementById('btn-lanzar').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Lanzando...';
}

function reiniciarApuesta() {
    reiniciarJuego();
}

function mostrarAnimacionMoneda(resultado) {
    const moneda = document.getElementById('moneda-multijugador');
    moneda.style.transition = 'transform 2s ease-out';
    
    // Animaci√≥n de giro
    const giros = 5; // N√∫mero de giros completos
    const gradosFinal = resultado === 'cara' ? 0 : 180;
    const gradosTotales = (giros * 360) + gradosFinal;
    
    moneda.style.transform = `rotateY(${gradosTotales}deg)`;
}

function mostrarResultadosFinales(data) {
    const resultadoDiv = document.createElement('div');
    resultadoDiv.className = 'alert alert-info mt-3';
    resultadoDiv.innerHTML = `<h5>Resultado: ${data.resultado_moneda.toUpperCase()}</h5>`;
    
    data.resultados.forEach(resultado => {
        const esYo = resultado.usuario_id === {{ current_user.id }};
        const resultadoItem = document.createElement('div');
        resultadoItem.className = `d-flex justify-content-between align-items-center p-2 border rounded mb-2 ${esYo ? 'bg-primary bg-opacity-25' : ''}`;
        resultadoItem.innerHTML = `
            <div class="text-start">
                <strong>${resultado.username}</strong>
                ${esYo ? ' <small class="text-info">(T√∫)</small>' : ''}
                <br>
                <small class="text-muted">Apost√≥: $${resultado.cantidad_apostada} por ${(resultado.gano ? data.resultado_moneda : (data.resultado_moneda === "cara" ? "cruz" : "cara"))}</small>
            </div>
            <div class="text-end fw-bold">
                <span class="balance-${resultado.gano ? 'positive' : 'negative'}">${resultado.gano ? `+$${resultado.ganancia.toFixed(2)}` : `-$${resultado.cantidad_apostada.toFixed(2)}`}</span>
                <br>
                <small class="text-muted">Nuevo: $${resultado.nuevo_balance.toFixed(2)}</small>
            </div>
        `;
        resultadoDiv.appendChild(resultadoItem);
        
        // Actualizar mi balance si soy yo (ya se hace arriba, pero por si acaso)
        if (esYo) {
            document.getElementById('balance-usuario').textContent = resultado.nuevo_balance.toFixed(2);
        }
    });
    
    document.getElementById('estado-juego').innerHTML = '';
    document.getElementById('estado-juego').appendChild(resultadoDiv);
    
    // Mostrar bot√≥n de reinicio
    document.getElementById('btn-reiniciar').style.display = 'inline-block';
    
    // Resetear estado despu√©s de 8 segundos (m√°s tiempo para leer resultados)
    setTimeout(() => {
        reiniciarJuego();
        apuestasActuales = [];
        actualizarContadores();
    }, 8000);
}

// NUEVA FUNCI√ìN: Reiniciar completamente el juego
function reiniciarJuego() {
    console.log('üîÑ Reiniciando juego para nueva ronda...');
    
    // Resetear variables
    ladoElegido = null;
    yaAposte = false;
    apuestasActuales = [];
    
    // Resetear interfaz
    document.getElementById('btn-elegir-cara').classList.replace('btn-danger', 'btn-outline-danger');
    document.getElementById('btn-elegir-cruz').classList.replace('btn-success', 'btn-outline-success');
    document.getElementById('eleccion-actual').textContent = 'No has elegido';
    document.getElementById('eleccion-actual').className = 'text-muted mt-1 d-block';
    
    document.getElementById('btn-apostar').disabled = false;
    document.getElementById('btn-apostar').innerHTML = '<i class="fas fa-coins me-1"></i>Apostar';
    
    if (esCreador) {
        document.getElementById('btn-lanzar').disabled = true; // Empezar deshabilitado
        document.getElementById('btn-lanzar').innerHTML = '<i class="fas fa-rocket me-1"></i>Lanzar Moneda';
    }
    
    document.getElementById('btn-reiniciar').style.display = 'none';
    
    // Resetear moneda
    const moneda = document.getElementById('moneda-multijugador');
    moneda.style.transition = 'none';
    moneda.style.transform = 'rotateY(0deg)';
    
    // Forzar reflow
    void moneda.offsetWidth;
    
    // Restaurar transici√≥n suave
    moneda.style.transition = 'transform 2s ease-out';
    
    // Resetear lista de apuestas
    document.getElementById('lista-apuestas').innerHTML = '<div class="text-center text-muted">No hay apuestas a√∫n</div>';
    
    // Resetear contadores
    document.getElementById('contador-apuestas').textContent = '0';
    
    // Resetear estado del juego
    document.getElementById('estado-juego').insertAdjacentHTML('beforeend', '<div class="alert alert-info">Esperando apuestas...</div>');
    
    console.log('‚úÖ Juego reiniciado para nueva ronda');
}

function actualizarApuestas() {
    const container = document.getElementById('lista-apuestas');
    
    if (apuestasActuales.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">No hay apuestas a√∫n</div>';
        return;
    }
    
    container.innerHTML = apuestasActuales.map(apuesta => `
        <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2 ${apuesta.usuario_id === {{ current_user.id }} ? 'bg-info bg-opacity-10' : ''}">
            <div>
                <strong>${apuesta.username}</strong>
                ${apuesta.usuario_id === {{ current_user.id }} ? '<small class="text-info">(T√∫)</small>' : ''}
                <span class="badge ${apuesta.eleccion === 'cara' ? 'bg-danger' : 'bg-success'}">
                    ${apuesta.eleccion.toUpperCase()}
                </span>
            </div>
            <div class="fw-bold">$${apuesta.cantidad}</div>
        </div>
    `).join('');
}

function actualizarContadores() {
    document.getElementById('contador-apuestas').textContent = apuestasActuales.length;
}

function actualizarBotones() {
    // Habilitar bot√≥n de lanzar si hay apuestas y es el creador
    if (esCreador) {
        document.getElementById('btn-lanzar').disabled = apuestasActuales.length === 0;
    }
}

function agregarEvento(mensaje) {
    const chat = document.getElementById('event-messages');
    
    // Remover mensaje de "est√° vac√≠o" si existe
    if (chat.querySelector('.text-muted')) {
        chat.innerHTML = '';
    }
    
    const mensajeDiv = document.createElement('div');
    mensajeDiv.innerHTML = mensaje;
    chat.appendChild(mensajeDiv);
    chat.scrollTop = chat.scrollHeight;
}
</script>

<style>
.coin-wrapper {
    width: 80%;
    max-width: 12em;
    aspect-ratio: 1 / 1;
    perspective: 1000px;
    margin: 0 auto;
}

.coin {
    width: 100%;
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 2s ease-out;
}

.face {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backface-visibility: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.face.front {
    background: radial-gradient(circle at 30% 30%, #fff59d 0%, #ffd54f 40%, #d4af37 100%);
    color: #2b2b2b;
    border: rgba(132, 104, 12, 0.7) 3px outset;
    box-shadow: 0 0 10px rgba(255, 196, 0, 0.6), 0 6px 30px rgba(255, 196, 0, 0.5);
}

.face.back {
    background: radial-gradient(circle at 30% 30%, #f3f4f6 0%, #c0c0c0 45%, #9d9d9d 100%);
    color: #1f1f1f;
    border: rgba(105, 105, 105, 0.75) 3px outset;
    transform: rotateY(180deg);
    box-shadow: 0 0 10px rgba(159, 192, 227, 0.7), 0 6px 30px rgba(159, 192, 227, 0.6);
}

.face-inner {
    text-align: center;
}

.emoji {
    font-size: 4rem;
    margin-bottom: 4px;
}

.label {
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    font-size: 1.2rem;
}
</style>
{% endblock %}