{% extends "pages/casino/juegos/base.html" %}

{% block title %}
PÃ³ker (multijugador)
{% endblock %}

{% block game_title %}
PÃ³ker
{% endblock %}

{% macro poker_role_label(role) -%}
  {%- if role == 'dealer' -%}D{%- elif role == 'small_blind' -%}SB{%- elif role == 'big_blind' -%}BB{%- endif -%}
{%- endmacro %}

{% set has_navbar_stats = true %}
{% block game_navbar_stats %}
<!-- Panel de informaciÃ³n -->
<div class="row">
  <div class="col">
    <div class="text-center">
      <div class="small text-uppercase text-nowrap">
        <i class="fas fa-coins me-1"></i>Balance inicial
      </div>
      <div class="h5 mb-0 stat-number fw-bold text-nowrap text-truncate">
        $<span id="balance-inicial">{{ "%.2f"|format(current_user.balance) }}</span>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="d-flex justify-content-between align-items-center gap-2">
      <div class="text-center">
        <div class="small text-uppercase text-nowrap">
          <i class="fas fa-trophy me-1"></i>Ãšltima ganancia
        </div>
        <div class="h5 mb-0 stat-number text-nowrap text-truncate" id="hud-table-amount">
          $0.00
        </div>
      </div>
      <button id="open-buyin" class="btn btn-outline-primary btn-sm text-nowrap" type="button">
        <i class="fas fa-pencil"></i>
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block content_fluid %}
<div class="row poker-stage overflow-auto">
  <div class="overflow-visible" style="padding-top: 8em;">
    <div class="poker-table">
      <div class="poker-table-inner">
        <div class="poker-pot">
          Bote total
          <strong id="poker-pot-amount">0â‚¬</strong>
          <small id="poker-current-bet">Apuesta a igualar: 0â‚¬</small>
          <small id="poker-blinds-info">Ciegas: 0â‚¬ / 0â‚¬</small>
        </div>
        <div class="poker-community-label">Cartas comunitarias</div>
        <div id="cartas-comunitarias" class="poker-community"></div>
        <div id="mesa-jugadores" class="poker-player-ring"></div>
      </div>
    </div>

    <div class="poker-hand-panel">
      <div>
        <div class="text-uppercase small text-muted mb-2">Tu mano</div>
        <div id="tus-cartas" class="poker-hand"></div>
      </div>
      <div class="poker-hand-meta">
        <div>Estado</div>
        <span id="estado-partida-badge" class="badge">Esperando inicioâ€¦</span>
        <small id="call-info" class="text-muted d-block mt-2">A igualar: 0â‚¬</small>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div id="buyin-overlay" class="modal fade" aria-labelledby="modalGameTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Elige tu buy-in</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3 text-muted" style="font-size:0.9rem;">Arrancas con 0â‚¬ en mesa. Mueve fichas desde tu cuenta y podrÃ¡s retirarlas cuando quieras.</p>
        <div class="buyin-stats">
          <div>
            <span class="label">Cuenta</span>
            <strong id="buyin-bank-label">0â‚¬</strong>
          </div>
          <div>
            <span class="label">En mesa</span>
            <strong id="buyin-table-label">0â‚¬</strong>
          </div>
        </div>
        <label for="buyin-input" class="buyin-label">Cantidad a llevar</label>
        <input id="buyin-input" type="number" min="0" step="0.01" class="buyin-input" />
        <div id="buyin-error" class="buyin-error"></div>
      </div>
      <div class="modal-footer">
        <button id="buyin-apply" class="btn btn-success" type="button">Meter a la mesa</button>
        <button id="buyin-withdraw" class="btn btn-warning btn-sm" type="button">Retirar cantidad</button>
        <button id="buyin-max" class="btn btn-primary btn-sm" type="button">Meter todo</button>
        <button id="buyin-clear" class="btn ghost btn-sm" type="button">Retirar todo</button>
      </div>
    </div>
  </div>
</div>

<!-- Lateral -->
<div class="row mt-4">
  <div class="col-12 mt-4">
    <div class="card">
      <div class="card-body">
        <div class="action-field">
          <label for="input-apuesta">Apuesta actual</label>
          <input id="input-apuesta" type="number" min="0" step="10" value="10">
        </div>
        <div class="action-buttons">
          <button id="btn-iniciar" class="btn btn-success">
            <i class="fas fa-play me-1"></i> Empezar mano
          </button>
          <button id="btn-call" class="btn btn-primary">
            <i class="fas fa-coins me-1"></i> Call
          </button>
          <button id="btn-check" class="btn ghost">
            <i class="fas fa-hand-paper me-1"></i> Check
          </button>
          <button id="btn-raise" class="btn btn-warning">
            <i class="fas fa-level-up-alt me-1"></i> Raise
          </button>
          <button id="btn-fold" class="btn btn-danger">
            <i class="fas fa-flag-checkered me-1"></i> Fold
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-8 mt-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <h5 class="mb-0">Jugadores</h5>
          <span class="text-muted small">Actualizado en tiempo real</span>
        </div>
        <div id="lista-jugadores" class="poker-player-list"></div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4 mt-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">Eventos</h5>
          <span class="text-muted small">Mesa {{ sala.id }}</span>
        </div>
        <div class="poker-log" id="log">
          <div class="text-muted small">Esperando a que el creador de la sala inicie la manoâ€¦</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ======== Config bÃ¡sica ========
const salaId = {{ sala.id }};
const currentUserId = {{ current_user.id }};
const isOwner = {{ 'true' if sala.creador_id == current_user.id else 'false' }};
const socket = window.socket || io();
const HAND_PHASES = new Set(['preflop', 'flop', 'turn', 'river']);
const initialBankCents = parseInt("{{ ((current_user.balance or 0) * 100)|int }}", 10) || 0;
const minBuyinCents = parseInt("{{ ((sala.apuesta_minima or 0) * 100)|int }}", 10) || 0;

// Elementos
const elMesa = {
  comunitarias: document.getElementById('cartas-comunitarias'),
  tusCartas: document.getElementById('tus-cartas'),
  jugadores: document.getElementById('lista-jugadores'),
  playerRing: document.getElementById('mesa-jugadores'),
  log: document.getElementById('log'),
  estadoBadge: document.getElementById('estado-partida-badge'),
  apuesta: document.getElementById('input-apuesta'),
  btnIniciar: document.getElementById('btn-iniciar'),
  btnCall: document.getElementById('btn-call'),
  btnCheck: document.getElementById('btn-check'),
  btnRaise: document.getElementById('btn-raise'),
  btnFold: document.getElementById('btn-fold'),
  potAmount: document.getElementById('poker-pot-amount'),
  currentBet: document.getElementById('poker-current-bet'),
  potBlinds: document.getElementById('poker-blinds-info'),
  callInfo: document.getElementById('call-info'),
  hudTable: document.getElementById('hud-table-amount'),
  buyinOverlay: document.getElementById('buyin-overlay'),
  buyinInput: document.getElementById('buyin-input'),
  buyinBankLabel: document.getElementById('buyin-bank-label'),
  buyinTableLabel: document.getElementById('buyin-table-label'),
  buyinError: document.getElementById('buyin-error'),
  buyinApply: document.getElementById('buyin-apply'),
  buyinWithdraw: document.getElementById('buyin-withdraw'),
  buyinMax: document.getElementById('buyin-max'),
  buyinClear: document.getElementById('buyin-clear'),
  buyinClose: document.getElementById('buyin-close'),
  openBuyin: document.getElementById('open-buyin'),
  withdrawAll: document.getElementById('withdraw-all')
};

const buyinModal = new bootstrap.Modal(elMesa.buyinOverlay);

// Desactivar botÃ³n iniciar si no es el creador
if (!isOwner){
  elMesa.btnIniciar.disabled = true;
  elMesa.btnIniciar.title = 'Solo el creador de la sala puede iniciar la mano';
}

// ====== Utilidades UI ======
function addLog(msg){
  const div = document.createElement('div');
  const ts = new Date().toLocaleTimeString();
  div.textContent = `[${ts}] ${msg}`;
  elMesa.log.prepend(div);
}

function formatCurrency(value){
  const num = Number(value || 0);
  return `$${num.toFixed(2)}`;
}

function formatCents(cents){
  return formatCurrency((Number(cents || 0)) / 100);
}

function formatTime(ts){
  if (!ts) return '';
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return '';
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Actualiza el badge verde global y el HUD de cuenta con el mismo valor
function setGlobalBalance(euros){
  const val = Number(euros || 0);
  const nav = document.getElementById('balance');
  if (nav){
    nav.textContent = val.toFixed(2);
    nav.dataset.balance = val;
  }
}
// Sobrescribimos siempre para asegurarnos de que el header se actualiza como el HUD
window.updateHeaderBalance = setGlobalBalance;

function addChatMessage(payload){
  if (!payload) return;
  if (elMesa.chatMessages.querySelector('.text-muted')){
    elMesa.chatMessages.innerHTML = '';
  }
  const row = document.createElement('div');
  row.className = 'chat-row';

  const meta = document.createElement('div');
  meta.className = 'chat-meta';
  const userSpan = document.createElement('span');
  userSpan.className = 'chat-user';
  userSpan.textContent = payload.username || 'Jugador';
  const timeSpan = document.createElement('span');
  timeSpan.className = 'chat-time';
  timeSpan.textContent = formatTime(payload.timestamp);
  meta.appendChild(userSpan);
  meta.appendChild(timeSpan);

  const msg = document.createElement('div');
  msg.className = 'chat-message';
  msg.textContent = payload.message || '';

  row.appendChild(meta);
  row.appendChild(msg);

  elMesa.chatMessages.appendChild(row);
  elMesa.chatMessages.scrollTop = elMesa.chatMessages.scrollHeight;
}

// ====== Buy-in ======
const buyinState = {
  bankCents: initialBankCents,
  tableCents: 0
};
let buyinEditing = false;
// El balance global es el saldo de cuenta (el mismo que muestra tu etiqueta "Cuenta")
function headerBalanceEuros(bankCentsOverride){
  const bank = (typeof bankCentsOverride === 'number') ? bankCentsOverride : buyinState.bankCents;
  return Math.max(0, bank) / 100;
}

function updateBuyinButtonsState(){
  const valEuros = parseFloat(elMesa.buyinInput?.value || '0');
  const valCents = Math.round((isNaN(valEuros) ? 0 : valEuros) * 100);
  const disableApply = !valCents || valCents <= 0;
  const disableWithdraw = disableApply || valCents > buyinState.tableCents;
  if (elMesa.buyinApply) elMesa.buyinApply.disabled = disableApply;
  if (elMesa.buyinWithdraw) elMesa.buyinWithdraw.disabled = disableWithdraw;
}

function syncBuyinLabels(){
  if (!elMesa.buyinBankLabel) return;
  elMesa.buyinBankLabel.textContent = formatCents(buyinState.bankCents);
  elMesa.buyinTableLabel.textContent = formatCents(buyinState.tableCents);
  const headerBalanceCents = Math.max(0, buyinState.bankCents);
  if (elMesa.hudTable) elMesa.hudTable.textContent = formatCents(buyinState.bankCents);
  setGlobalBalance(headerBalanceCents / 100);
  if (elMesa.buyinInput && !buyinEditing){
    const suggested = Math.max(minBuyinCents, 0);
    elMesa.buyinInput.value = Math.max(suggested / 100, 0).toFixed(2);
    updateBuyinButtonsState();
  }
}

function toggleBuyinOverlay(show){
  if (show) {
    buyinModal.show();
    elMesa.buyinError.textContent = '';
    syncBuyinLabels();
    if (elMesa.buyinInput){
      const defaultVal = Math.max(minBuyinCents, 0);
      elMesa.buyinInput.value = (defaultVal / 100).toFixed(2);
      elMesa.buyinInput.focus();
      updateBuyinButtonsState();
    }
  }
  else {
    buyinModal.hide();
  }
}

async function aplicarBuyin(cents){
  if (cents < 0){
    elMesa.buyinError.textContent = 'La cantidad no puede ser negativa';
    return;
  }
  if (cents > buyinState.bankCents + buyinState.tableCents){
    elMesa.buyinError.textContent = 'No tienes fondos suficientes en la cuenta para sentar esa cantidad.';
    return;
  }
  elMesa.buyinError.textContent = '';
  try{
    const resp = await fetch(`/api/multijugador/poker/stack/${salaId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ stack: (cents / 100) })
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok){
      elMesa.buyinError.textContent = data.error || 'No se pudo ajustar el buy-in';
      addLog(data.error || 'No se pudo ajustar el buy-in');
      return;
    }
    const stackCents = Math.round(Number(data.stack || data.stack_nuevo || (cents / 100)) * 100);
    const cuentaCents = Math.round(Number(data.saldo_cuenta ?? data.balance_usuario ?? buyinState.bankCents) * 100);
    buyinState.tableCents = Math.max(0, stackCents);
    buyinState.bankCents = Math.max(0, cuentaCents);
    syncBuyinLabels();
    addLog(data.mensaje || `Stack actualizado: mesa ${formatCents(buyinState.tableCents)}, cuenta ${formatCents(buyinState.bankCents)}`);
    if (data.balance_usuario !== undefined && window.updateHeaderBalance){
      const bankCents = Math.round(Number(data.balance_usuario || 0) * 100);
      buyinState.bankCents = bankCents;
      setGlobalBalance(headerBalanceEuros(bankCents));
    }
    toggleBuyinOverlay(false);
    getEstado();
  }catch(err){
    elMesa.buyinError.textContent = 'Error de red al ajustar buy-in';
    addLog('Error de red al ajustar buy-in');
  }
}

if (elMesa.buyinApply){
  elMesa.buyinApply.addEventListener('click', () => {
    const euros = parseFloat(elMesa.buyinInput.value || '0');
    aplicarBuyin(Math.round(euros * 100));
  });
}
if (elMesa.buyinWithdraw){
  elMesa.buyinWithdraw.addEventListener('click', () => {
    const euros = parseFloat(elMesa.buyinInput.value || '0');
    const cents = Math.round(euros * 100);
    if (cents < 0){
      elMesa.buyinError.textContent = 'La cantidad no puede ser negativa';
      return;
    }
    if (cents > buyinState.tableCents){
      elMesa.buyinError.textContent = 'No tienes tanto en la mesa para retirar.';
      return;
    }
    aplicarBuyin(Math.max(0, buyinState.tableCents - cents));
  });
}
if (elMesa.buyinMax){
  elMesa.buyinMax.addEventListener('click', () => {
    aplicarBuyin(buyinState.bankCents + buyinState.tableCents);
  });
}
if (elMesa.buyinClear){
  elMesa.buyinClear.addEventListener('click', () => aplicarBuyin(0));
}
if (elMesa.buyinClose){
  elMesa.buyinClose.addEventListener('click', () => toggleBuyinOverlay(false));
}
if (elMesa.openBuyin){
  elMesa.openBuyin.addEventListener('click', () => toggleBuyinOverlay(true));
}
if (elMesa.withdrawAll){
  elMesa.withdrawAll.addEventListener('click', () => aplicarBuyin(0));
}
if (elMesa.buyinInput){
  elMesa.buyinInput.addEventListener('focus', () => { buyinEditing = true; });
  elMesa.buyinInput.addEventListener('blur', () => { buyinEditing = false; });
   elMesa.buyinInput.addEventListener('input', updateBuyinButtonsState);
}
toggleBuyinOverlay(true);
syncBuyinLabels();

function renderCarta(carta, { mini=false, back=false } = {}){
  const div = document.createElement('div');
  div.className = `poker-card${mini ? ' mini' : ''}`;
  if (back || !carta){
    div.classList.add('poker-card-back');
    div.innerHTML = '<span>ðŸ‚ </span>';
    return div;
  }
  const roja = ['â™¥', 'â™¦'].includes(carta.palo) ? ' roja' : '';
  div.innerHTML = `
    <span class="poker-card-value${roja}">${carta.valor}</span>
    <span class="poker-card-suit${roja}">${carta.palo}</span>
  `;
  return div;
}

function renderEstado(estado){
  elMesa.estadoBadge.textContent = estado.texto;
  elMesa.estadoBadge.className = 'badge ' + estado.clase;
}

// ====== Pintar estado que viene del backend ======
function ordenarJugadoresParaMesa(jugadores, ordenLista){
  const mapa = jugadores || {};
  const lista = [];
  if (Array.isArray(ordenLista) && ordenLista.length){
    ordenLista.forEach(uid => {
      const jugador = mapa[String(uid)];
      if (jugador) lista.push(jugador);
    });
    Object.values(mapa).forEach(j => {
      if (!ordenLista.includes(j.user_id)){
        lista.push(j);
      }
    });
  } else {
    Object.values(mapa).forEach(j => lista.push(j));
    lista.sort((a, b) => a.user_id - b.user_id);
  }
  if (!lista.length) return [];
  const idxYo = lista.findIndex(j => j.user_id === currentUserId);
  if (idxYo > 0){
    return lista.slice(idxYo).concat(lista.slice(0, idxYo));
  }
  return lista;
}

function seatIndexForPosition(position, total){
  if (total <= 0) return 0;
  if (total >= 6) return Math.min(position, 5);
  const raw = Math.round((position / total) * 6);
  return Math.min(raw, 5);
}

function renderEstadoPartida(st){
  // Estado badge
  if (st.fase !== 'terminada'){
    renderEstadoPartida._ultimoGanadorMostrado = null;
  }
  const estados = {
    esperando: { texto: 'Esperando jugadores', clase: 'bg-secondary' },
    repartiendo: { texto: 'Repartiendo cartas', clase: 'bg-info' },
    apuestas: { texto: 'Ronda de apuestas', clase: 'bg-warning text-dark' },
    showdown: { texto: 'Mostrando manos', clase: 'bg-success' },
    terminada: { texto: 'Mano terminada', clase: 'bg-dark' },
    preflop: { texto: 'Preflop', clase: 'bg-primary' },
    flop: { texto: 'Flop', clase: 'bg-primary' },
    turn: { texto: 'Turn', clase: 'bg-primary' },
    river: { texto: 'River', clase: 'bg-primary' },
  };
  renderEstado(estados[st.fase] || estados.esperando);
  elMesa.potAmount.textContent = formatCurrency(st.bote || 0);
  elMesa.currentBet.textContent = `Apuesta a igualar: ${formatCurrency(st.apuesta_ronda || 0)}`;
  elMesa.potBlinds.textContent = `Ciegas: ${formatCurrency(st.small_blind || 0)} / ${formatCurrency(st.big_blind || 0)}`;

  // Cartas comunitarias
  elMesa.comunitarias.innerHTML = '';
  const comunitarias = st.cartas_comunitarias_visibles || [];
  if (!comunitarias.length){
    Array.from({ length: 5 }).forEach(() => elMesa.comunitarias.appendChild(renderCarta(null, { back: true })));
  } else {
    comunitarias.forEach(carta => {
      elMesa.comunitarias.appendChild(renderCarta(carta));
    });
  }

  // Tus cartas
  const jugadoresEstado = st.jugadores || {};
  const yo = jugadoresEstado[String(currentUserId)];
  const turnoJugador = jugadoresEstado[String(st.turno_actual)];
  elMesa.tusCartas.innerHTML = '';
  if (yo && yo.cartas){
    yo.cartas.forEach(c => elMesa.tusCartas.appendChild(renderCarta(c)));
  } else {
    Array.from({ length: 2 }).forEach(() => elMesa.tusCartas.appendChild(renderCarta(null, { back: true })));
  }

  const manoActiva = HAND_PHASES.has(st.fase);
  const apuestaActualUsuario = yo ? Number(yo.apuesta_actual || 0) : 0;
  const callAmount = Math.max(0, (st.apuesta_ronda || 0) - apuestaActualUsuario);
  const hayGanadores = Array.isArray(st.ganador) && st.ganador.length > 0;
  const esMiTurno = Number(st.turno_actual) === currentUserId;
  const puedoActuar = manoActiva && yo && yo.estado === 'activo' && esMiTurno && !hayGanadores;
  elMesa.callInfo.textContent = esMiTurno
    ? `Es tu turno Â· A igualar: ${formatCurrency(callAmount)}`
    : turnoJugador
      ? `Turno de ${turnoJugador.username} Â· A igualar: ${formatCurrency(callAmount)}`
      : `A igualar: ${formatCurrency(callAmount)}`;
  elMesa.btnCall.disabled = !puedoActuar || callAmount <= 0;
  elMesa.btnCheck.disabled = !puedoActuar || callAmount > 0;
  elMesa.btnRaise.disabled = !puedoActuar;
  elMesa.btnFold.disabled = !puedoActuar;
  elMesa.btnCall.innerHTML = callAmount > 0
    ? `<i class="fas fa-coins me-1"></i> Call ${formatCurrency(callAmount)}`
    : `<i class="fas fa-coins me-1"></i> Call`;

  // Actualizar saldos locales de buy-in
  if (yo){
    const stackCents = Math.round(Number(yo.stack || 0) * 100);
    const cuentaCents = Math.round(Number(yo.saldo_cuenta ?? yo.stack ?? 0) * 100);
    buyinState.tableCents = stackCents;
    buyinState.bankCents = cuentaCents;
    syncBuyinLabels();
    setGlobalBalance(headerBalanceEuros(cuentaCents));
  }

  // Jugadores (panel lateral)
  elMesa.jugadores.innerHTML = '';
  Object.values(jugadoresEstado).forEach(j => {
    const col = document.createElement('div');
    let className = 'poker-player-row';
    if (j.user_id === currentUserId) className += ' me';
    if (j.es_ganador) className += ' winner';
    if (j.user_id === st.turno_actual) className += ' turno';
    col.className = className;
    const roleLabel = j.rol === 'dealer' ? 'D' : j.rol === 'small_blind' ? 'SB' : j.rol === 'big_blind' ? 'BB' : null;
    const roleBadge = roleLabel ? `<span class="badge role ${j.rol}">${roleLabel}</span>` : '';
    const turnoBadge = j.user_id === st.turno_actual ? `<span class="badge turno-badge">Turno</span>` : '';
    col.innerHTML = `
      <div class="row-top">
        <div class="d-flex align-items-center gap-1">
          ${roleBadge}
          <strong>${j.username}</strong>
        </div>
        <div class="d-flex align-items-center gap-1">
          ${turnoBadge}
          <span class="badge ${j.estado === 'activo' ? 'bg-success' : 'bg-secondary'}">${j.estado}</span>
        </div>
      </div>
      <div class="row-body">
        <div>Mesa: <strong>${formatCurrency(j.stack)}</strong></div>
        <div>Cuenta: <strong>${j.user_id === currentUserId ? formatCurrency(j.saldo_cuenta ?? j.stack) : 'â€”'}</strong></div>
      </div>
      <div class="row-body secondary">
        <div>Total aportado: <strong>${formatCurrency(j.total_aportado)}</strong></div>
        <div>En ronda: <strong>${formatCurrency(j.apuesta_actual)}</strong></div>
      </div>
      <div class="row-foot">
        <div>Ãšltima acciÃ³n: <em>${j.ultima_accion || '-'}</em></div>
        ${j.ultima_ganancia ? `<div class="text-success">+${formatCurrency(j.ultima_ganancia)}</div>` : ''}
      </div>
    `;
    elMesa.jugadores.appendChild(col);
  });

  // Jugadores alrededor de la mesa
  const orden = ordenarJugadoresParaMesa(jugadoresEstado, st.orden_turnos);
  elMesa.playerRing.innerHTML = '';
  orden.forEach((j, idx) => {
    const seatIndex = seatIndexForPosition(idx, orden.length || 1);
    const seat = document.createElement('div');
    let seatClass = `poker-seat seat-${seatIndex}`;
    if (j.user_id === currentUserId) seatClass += ' me';
    if (j.estado !== 'activo') seatClass += ' inactive';
    if (j.es_ganador) seatClass += ' winner';
    if (j.user_id === st.turno_actual) seatClass += ' turno';
    seat.className = seatClass;
    const roleLabel = j.rol === 'dealer' ? 'D' : j.rol === 'small_blind' ? 'SB' : j.rol === 'big_blind' ? 'BB' : '';
    seat.innerHTML = `
      <div class="avatar">${(j.username || '?').slice(0, 2).toUpperCase()}</div>
      <div class="info">
        ${roleLabel ? `<div class="role-chip ${j.rol}">${roleLabel}</div>` : ''}
        <div class="name">${j.username}</div>
        <div class="stack">Mesa: ${formatCurrency(j.stack)}</div>
        <div class="bank">Cuenta: ${j.user_id === currentUserId ? formatCurrency(j.saldo_cuenta ?? j.stack) : 'â€”'}</div>
        <div class="last">${j.ultima_accion || '---'}</div>
      </div>
    `;
    if (j.cartas_visibles){
      const cardsWrap = document.createElement('div');
      cardsWrap.className = 'seat-cards';
      j.cartas_visibles.forEach(c => cardsWrap.appendChild(renderCarta(c, { mini: true })));
      seat.appendChild(cardsWrap);
    }
    if (j.mano_ganadora && j.mano_ganadora.length){
      const best = document.createElement('div');
      best.className = 'seat-best-hand';
      best.innerHTML = `<span>${j.mano_texto || 'Mejor mano'}</span>`;
      const bestCards = document.createElement('div');
      bestCards.className = 'seat-best-cards';
      j.mano_ganadora.forEach(c => bestCards.appendChild(renderCarta(c, { mini: true })));
      best.appendChild(bestCards);
      seat.appendChild(best);
    }
    elMesa.playerRing.appendChild(seat);
  });

  // Mostrar ganadores en log
  if (Array.isArray(st.ganador) && st.ganador.length){
    const key = JSON.stringify(st.ganador.map(g => g.user_id).sort());
    if (renderEstadoPartida._ultimoGanadorMostrado !== key){
      const resumen = st.ganador.map(g => `${g.username} (+${formatCurrency(g.ganancia)})`).join(', ');
      addLog(`Ganador/es: ${resumen}`);
      renderEstadoPartida._ultimoGanadorMostrado = key;
    }
  } else {
    renderEstadoPartida._ultimoGanadorMostrado = null;
  }
}

// ====== Llamadas API ======
async function getEstado(){
  const resp = await fetch(`/api/multijugador/poker/estado/${salaId}`);
  if (!resp.ok) return;
  const data = await resp.json();
  renderEstadoPartida(data);
}

async function postAccion(path, body){
  const resp = await fetch(`/api/multijugador/poker/${path}/${salaId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body || {})
  });
  const data = await resp.json().catch(() => ({}));
  if (!resp.ok){
    addLog(data.error || 'Error en la acciÃ³n');
  } else if (data.mensaje){
    addLog(data.mensaje);
  }
  getEstado();
  if (data.nuevo_balance !== undefined && window.updateHeaderBalance){
    const bankCents = Math.round(Number(data.nuevo_balance || 0) * 100);
    buyinState.bankCents = bankCents;
    const totalCuenta = headerBalanceEuros(bankCents);
    setGlobalBalance(totalCuenta);
  }
}

// Fallback para actualizar el badge verde global si el layout no define updateHeaderBalance
if (typeof window.updateHeaderBalance !== 'function'){
  window.updateHeaderBalance = function(total){
    const el = document.getElementById('balance');
    if (el){
      const num = Number(total || 0);
      el.textContent = num.toFixed(2);
      el.dataset.balance = num;
    }
  };
}

// ====== Eventos botones ======
elMesa.btnIniciar.addEventListener('click', () => {
  postAccion('iniciar', {});
});
elMesa.btnCall.addEventListener('click', () => {
  postAccion('call', {});
});
elMesa.btnCheck.addEventListener('click', () => {
  postAccion('check', {});
});
elMesa.btnRaise.addEventListener('click', () => {
  const cantidad = Number(elMesa.apuesta.value || 0);
  postAccion('raise', { cantidad });
});
elMesa.btnFold.addEventListener('click', () => {
  postAccion('fold', {});
});

// ====== Eventos Socket.IO ======
function describeWinningHand(winner){
  const mano = Array.isArray(winner.mano) ? winner.mano : [];
  const manoTexto = winner.mano_texto || 'Mejor mano';
  const valores = {};
  mano.forEach(c => { if(!c) return; const v = c.valor; valores[v] = (valores[v]||0)+1; });
  const byCount = Object.entries(valores).sort((a,b)=>b[1]-a[1] || b[0].localeCompare(a[0]));
  const cardStr = (c)=> `${c.valor || ''}${c.palo || ''}`;
  const listStr = mano.map(cardStr).filter(Boolean).join(', ');
  if(byCount.length){
    const [val, cnt] = byCount[0];
    const sameCards = mano.filter(c => c && c.valor === val).map(cardStr).join(' ');
    if(cnt === 4) return `PÃ³ker de ${val} (${sameCards})`;
    if(cnt === 3) return `TrÃ­o de ${val} (${sameCards})`;
    if(cnt === 2){
      const second = byCount[1] && byCount[1][1] === 2 ? byCount[1][0] : null;
      if(second){
        const secondCards = mano.filter(c => c && c.valor === second).map(cardStr).join(' ');
        return `Doble pareja ${val}/${second} (${sameCards} ${secondCards})`;
      }
      return `Pareja de ${val} (${sameCards})`;
    }
  }
  return `${manoTexto} (${listStr})`;
}

socket.on('poker_hand_summary', (data = {}) => {
  if (Number(data.sala_id) !== salaId) return;
  const bote = formatCurrency(data.bote || 0);
  const winners = Array.isArray(data.ganadores) ? data.ganadores : [];
  winners.forEach((w, idx) => {
    const mano = describeWinningHand(w);
    const gan = formatCurrency(w.ganancia || 0);
    const message = `Ganador${winners.length > 1 ? ` ${idx + 1}` : ''}: ${w.username || 'Jugador'} se lleva ${gan} del bote (${bote}) con ${mano}`;
    addChatMessage({
      username: 'Mesa',
      message,
      timestamp: data.timestamp || new Date().toISOString()
    });
  });
});

socket.on('poker_estado_actualizado', (payload = {}) => {
  if (Number(payload.sala_id) === salaId){
    getEstado();
  }
});

socket.on('poker_error', (data = {}) => {
  if (data.error){
    addLog(`Socket: ${data.error}`);
  }
});

socket.emit('poker_join', { sala_id: salaId });

window.addEventListener('beforeunload', () => {
  socket.emit('poker_leave', { sala_id: salaId });
});

// ====== Polling sencillo ======
getEstado();
setInterval(getEstado, 3000);
</script>

<style>
.poker-wrapper {
  color: #ecf4ff;
}
.poker-layout {
  display: grid;
  grid-template-columns: minmax(0, 1fr) 320px;
  gap: 1.5rem;
}
@media (max-width: 1200px) {
  .poker-layout {
    grid-template-columns: 1fr;
  }
}
.poker-stage {
  background: radial-gradient(circle at 30% 20%, rgba(30, 255, 233, 0.1), rgba(9, 13, 39, 0.95));
  border-top: 1px solid rgba(255,255,255,0.1);
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.poker-hud {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin-bottom: 1.5rem;
}
.hud-pill {
  padding: 0.75rem 1rem;
  border-radius: 16px;
  background: rgba(8, 12, 34, 0.8);
  border: 1px solid rgba(255,255,255,0.08);
  min-width: 140px;
}
.hud-pill span {
  display: block;
  font-weight: 600;
}
.hud-pill small {
  color: rgba(255,255,255,0.6);
}
.hud-pill.hud-user {
  background: linear-gradient(135deg, rgba(77, 172, 255, 0.2), rgba(50, 78, 255, 0.1));
  border-color: rgba(77, 172, 255, 0.4);
}
.poker-table {
  position: relative;
  margin-bottom: 1.5rem;
}
.poker-table-inner {
  position: relative;
  border-radius: 999px;
  background: radial-gradient(circle, rgba(28, 109, 76, 0.9), rgba(11, 33, 26, 0.95));
  border: 4px solid rgba(0,0,0,0.65);
  min-height: 460px;
  padding: 2.5rem 3.5rem 4.5rem;
  box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  overflow: visible;
}
.poker-pot {
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-size: 0.85rem;
  color: rgba(255,255,255,0.7);
}
.poker-pot strong {
  display: block;
  font-size: 2rem;
  color: #ffd369;
}
.poker-pot small {
  display: block;
  margin-top: 0.2rem;
  font-size: 0.8rem;
  text-transform: none;
  color: rgba(255,255,255,0.75);
}
.poker-community-label {
  font-size: 0.85rem;
  text-transform: uppercase;
  color: rgba(255,255,255,0.6);
  margin-top: 0.5rem;
}
.poker-community {
  display: flex;
  gap: 0.7rem;
  justify-content: center;
  align-items: center;
  flex-wrap: nowrap;
  padding: 0.5rem 1rem;
  border-radius: 999px;
}
.poker-player-ring {
  position: absolute;
  inset: -3.5rem;
  pointer-events: none;
}
.poker-seat {
  position: absolute;
  width: 132px;
  background: rgba(5, 8, 24, 0.92);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 0.55rem 0.65rem;
  font-size: 0.78rem;
  box-shadow: 0 8px 25px rgba(0,0,0,0.4);
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
  align-items: flex-start;
  pointer-events: none;
}
.poker-seat.me {
  border-color: #ffd369;
  box-shadow: 0 0 20px rgba(255,211,105,0.4);
}
.poker-seat.turno {
  border-color: #4fc3f7;
  box-shadow: 0 0 22px rgba(79,195,247,0.5);
}
.poker-seat.inactive {
  opacity: 0.45;
}
.poker-seat.winner {
  border-color: #4caf50;
  box-shadow: 0 0 22px rgba(76,175,80,0.45);
}
.poker-seat .avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  display: grid;
  place-items: center;
  font-weight: 700;
  font-size: 0.85rem;
}
.poker-seat .info {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
  pointer-events: auto;
}
.role-chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 18px;
  border-radius: 999px;
  font-size: 0.65rem;
  text-transform: uppercase;
  margin-bottom: 2px;
  background: rgba(255,255,255,0.12);
}
.role-chip.dealer {
  background: rgba(255,215,64,0.4);
  color: #1a1200;
}
.role-chip.small_blind {
  background: rgba(129,212,250,0.3);
  color: #06121f;
}
.role-chip.big_blind {
  background: rgba(255,138,101,0.35);
  color: #1f0d05;
}
.poker-seat .name {
  font-weight: 700;
}
.poker-seat .stack {
  color: #8df1ba;
  font-weight: 600;
  font-size: 0.85rem;
}
.poker-seat .bank {
  font-size: 0.8rem;
  color: rgba(255,255,255,0.7);
}
.poker-seat .last {
  font-size: 0.75rem;
  color: rgba(255,255,255,0.55);
}
.seat-cards {
  display: flex;
  gap: 0.25rem;
  margin-top: 0.25rem;
}
.seat-best-hand {
  position: absolute;
  left: 50%;
  bottom: -70px;
  transform: translateX(-50%);
  background: rgba(3,5,18,0.92);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  padding: 0.35rem 0.5rem;
  font-size: 0.74rem;
  color: rgba(255,255,255,0.85);
  text-align: center;
  box-shadow: 0 12px 24px rgba(0,0,0,0.45);
  min-width: 136px;
}
.seat-best-cards {
  display: flex;
  gap: 0.25rem;
  margin-top: 0.2rem;
  justify-content: center;
}
.poker-seat.seat-0 { top: 92%; left: 50%; transform: translate(-50%, -50%); }
.poker-seat.seat-1 { top: 66%; right: -52px; transform: translateY(-50%); }
.poker-seat.seat-2 { top: 28%; right: -52px; transform: translateY(-50%); }
.poker-seat.seat-3 { top: 6%; left: 50%; transform: translate(-50%, -50%); }
.poker-seat.seat-4 { top: 28%; left: -52px; transform: translateY(-50%); }
.poker-seat.seat-5 { top: 66%; left: -52px; transform: translateY(-50%); }
.poker-hand-panel {
  display: flex;
  justify-content: space-between;
  gap: 1rem;
  flex-wrap: wrap;
  align-items: center;
  margin-bottom: 1rem;
}
.poker-hand {
  display: flex;
  gap: 0.75rem;
}
.poker-hand-meta {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  text-align: right;
}
.poker-hand-meta .badge {
  background: #2f3649;
}
.poker-actions {
  background: rgba(5, 7, 22, 0.85);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.06);
  padding: 1.25rem;
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: flex-end;
}
.action-field {
  flex: 1;
  min-width: 200px;
}
.action-field label {
  display: block;
  font-size: 0.85rem;
  color: rgba(255,255,255,0.7);
  margin-bottom: 0.35rem;
}
.action-field input {
  width: 100%;
  padding: 0.65rem;
  border-radius: 12px;
  background: rgba(0,0,0,0.35);
  border: 1px solid rgba(255,255,255,0.1);
  color: #fff;
}
.action-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  justify-content: flex-end;
}
.poker-sidebar {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}
.poker-panel {
  background: rgba(6, 8, 29, 0.85);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.08);
  padding: 1.25rem;
  box-shadow: 0 20px 60px rgba(0,0,0,0.35);
}
.poker-player-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
.poker-player-row {
  background: rgba(15,17,35,0.9);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.04);
  padding: 0.85rem;
  font-size: 0.85rem;
}
.poker-player-row.me {
  border-color: rgba(255, 211, 105, 0.5);
}
.poker-player-row.winner {
  border-color: rgba(76,175,80,0.7);
  box-shadow: 0 0 15px rgba(76,175,80,0.2);
}
.poker-player-row.turno {
  border-color: rgba(79,195,247,0.6);
}
.poker-player-row .row-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.35rem;
}
.poker-player-row .row-body {
  display: flex;
  justify-content: space-between;
  font-weight: 600;
  color: #9efadd;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.poker-player-row .row-body.secondary {
  font-size: 0.8rem;
  color: rgba(255,255,255,0.75);
}
.poker-player-row .row-foot {
  margin-top: 0.35rem;
  font-size: 0.78rem;
  color: rgba(255,255,255,0.6);
  display: flex;
  justify-content: space-between;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.badge.role {
  background: rgba(255,255,255,0.15);
  color: #fff;
  font-size: 0.65rem;
}
.badge.role.small_blind {
  background: rgba(129,212,250,0.25);
  color: #031728;
}
.badge.role.big_blind {
  background: rgba(255,138,101,0.35);
  color: #2b1106;
}
.badge.role.dealer {
  background: rgba(255,215,64,0.5);
  color: #1c1200;
}
.badge.turno-badge {
  background: rgba(79,195,247,0.4);
  color: #052534;
}
.poker-card {
  width: 60px;
  height: 86px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(7,10,26,0.75);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  font-weight: 700;
  box-shadow: 0 10px 25px rgba(0,0,0,0.35);
}
.poker-card.mini {
  width: 40px;
  height: 60px;
  font-size: 0.9rem;
}
.poker-card-back {
  background: linear-gradient(135deg, rgba(0,0,0,0.75), rgba(36,44,78,0.95));
  color: rgba(255,255,255,0.5);
  font-size: 1.4rem;
}
.poker-card-value,
.poker-card-suit {
  line-height: 1.1;
}
.poker-card-value.roja,
.poker-card-suit.roja {
  color: #ff8d8d;
}
.poker-log {
  max-height: 220px;
  overflow-y: auto;
  font-size: 0.85rem;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}
.poker-chat-box {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
/* Buy-in overlay */
.buyin-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}
.buyin-stats .label {
  display: block;
  color: rgba(255,255,255,0.65);
  font-size: 0.85rem;
}
.buyin-label {
  display: block;
  margin-bottom: 0.25rem;
  color: rgba(255,255,255,0.7);
}
.buyin-input {
  width: 100%;
  padding: 0.75rem;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(0,0,0,0.4);
  color: #fff;
  margin-bottom: 0.5rem;
}
.buyin-error {
  color: #ff8a8a;
  min-height: 18px;
  font-size: 0.85rem;
  margin-bottom: 0.4rem;
}
.buyin-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  flex-wrap: wrap;
}
</style>

{% endblock %}
