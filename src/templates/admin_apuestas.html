{% extends "base/base_admin.html" %}

{% block title %}
Apuestas
{% endblock %}

{% block content %}
<h1>ğŸ° GestiÃ³n de Apuestas</h1>

<div class="row g-3 mt-3">
    <!-- Tarjetas de Resumen Mejoradas -->
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card stat-card h-100">
            <div class="card-body text-center p-2">
                <div class="stat-icon">ğŸ’°</div>
                <h6 class="mb-1">Total</h6>
                <div class="stat-number">{{ apuestas.total }}</div>
                <small class="text-muted">Apuestas</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card stat-card h-100">
            <div class="card-body text-center p-2">
                <div class="stat-icon">ğŸ“Š</div>
                <h6 class="mb-1">PÃ¡gina</h6>
                <div class="stat-number text-info">{{ apuestas.page }}</div>
                <small class="text-muted">de {{ apuestas.pages }}</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card stat-card h-100">
            <div class="card-body text-center p-2">
                <div class="stat-icon">ğŸ”„</div>
                <h6 class="mb-1">Por PÃ¡gina</h6>
                <div class="stat-number text-warning">{{ apuestas.per_page }}</div>
                <small class="text-muted">Registros</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card stat-card h-100">
            <div class="card-body text-center p-2">
                <div class="stat-icon">âœ…</div>
                <h6 class="mb-1">Ganadas</h6>
                <div class="stat-number text-success">{{ apuestas_ganadas }}</div>
                <small class="text-muted">Victorias</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card stat-card h-100">
            <div class="card-body text-center p-2">
                <div class="stat-icon">âŒ</div>
                <h6 class="mb-1">Perdidas</h6>
                <div class="stat-number text-danger">{{ apuestas_perdidas }}</div>
                <small class="text-muted">Derrotas</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card stat-card h-100">
            <div class="card-body text-center p-2">
                <div class="stat-icon">âš¡</div>
                <h6 class="mb-1">Filtros</h6>
                <div class="stat-number {% if juego_actual or resultado_actual %}text-success{% else %}text-muted{% endif %}">
                    {% if juego_actual or resultado_actual %}ON{% else %}OFF{% endif %}
                </div>
                <small class="text-muted">Activos</small>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="card glass-card">
            <div class="card-header cyber-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="h4 mb-0">ğŸ¯ Historial de Apuestas</span>
                        {% if juego_actual or resultado_actual %}
                        <span class="badge bg-pulse ms-2">Filtrado</span>
                        {% endif %}
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="text-muted me-2 small">Mostrando</span>
                        <span class="badge bg-cyan">{{ apuestas.items|length }}</span>
                    </div>
                </div>
            </div>
            <div class="card-body p-3">
                <!-- Filtros AutomÃ¡ticos Mejorados -->
                <div class="row g-3 mb-4">
                    <div class="col-lg-5 col-md-6">
                        <div class="filter-group">
                            <label class="filter-label">ğŸ® Filtrar por Juego</label>
                            <select class="form-select cyber-select" id="juegoFilter">
                                <option value="">Todos los juegos</option>
                                <option value="blackjack" {% if juego_actual == 'blackjack' %}selected{% endif %}>ğŸ² Blackjack</option>
                                <option value="poker" {% if juego_actual == 'poker' %}selected{% endif %}>ğŸƒ Poker</option>
                                <option value="coinflip" {% if juego_actual == 'coinflip' %}selected{% endif %}>ğŸª™ Coinflip</option>
                                <option value="tragaperras" {% if juego_actual == 'tragaperras' %}selected{% endif %}>ğŸ° Tragaperras</option>
                                <option value="caballos" {% if juego_actual == 'caballos' %}selected{% endif %}>ğŸ‡ Carrera de Caballos</option>
                                <option value="ruleta" {% if juego_actual == 'ruleta' %}selected{% endif %}>ğŸ¯ Ruleta</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-5 col-md-6">
                        <div class="filter-group">
                            <label class="filter-label">ğŸ¯ Filtrar por Resultado</label>
                            <select class="form-select cyber-select" id="resultadoFilter">
                                <option value="">Todos los resultados</option>
                                <option value="ganada" {% if resultado_actual == 'ganada' %}selected{% endif %}>âœ… Ganadas</option>
                                <option value="perdida" {% if resultado_actual == 'perdida' %}selected{% endif %}>âŒ Perdidas</option>
                                <option value="empate" {% if resultado_actual == 'empate' %}selected{% endif %}>âš¡ Empates</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-12 d-flex align-items-end">
                        <button class="btn btn-outline-cyan w-100" onclick="clearFilters()" 
                                {% if not juego_actual and not resultado_actual %}disabled{% endif %}>
                            ğŸ—‘ï¸ Limpiar
                        </button>
                    </div>
                </div>

                <!-- Indicador de Filtros Activos -->
                {% if juego_actual or resultado_actual %}
                <div class="alert alert-cyber mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>ğŸ›ï¸ Filtros Activos:</strong>
                            {% if juego_actual %}
                            <span class="badge bg-game me-2">ğŸ® {{ juego_actual|title }}</span>
                            {% endif %}
                            {% if resultado_actual %}
                            <span class="badge bg-result">ğŸ¯ {{ resultado_actual|title }}</span>
                            {% endif %}
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="me-2">ğŸ“Š</span>
                            <strong class="text-cyan">{{ apuestas.total }}</strong>
                            <span class="ms-1">apuestas encontradas</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Tabla Mejorada -->
                <div class="table-responsive">
                    <table class="table table-cyber">
                        <thead class="cyber-thead">
                            <tr>
                                <th class="cyber-th">ID</th>
                                <th class="cyber-th">Usuario</th>
                                <th class="cyber-th">Juego</th>
                                <th class="cyber-th">Apuesta</th>
                                <th class="cyber-th">Resultado</th>
                                <th class="cyber-th">Ganancia</th>
                                <th class="cyber-th">Fecha</th>
                                <th class="cyber-th">Neto</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for apuesta in apuestas.items %}
                            <tr class="cyber-row">
                                <td class="cyber-td">
                                    <span class="id-badge">#{{ apuesta.id }}</span>
                                </td>
                                <td class="cyber-td">
                                    <a href="{{ url_for('admin_usuario_detalle.home', user_id=apuesta.user.id) }}" 
                                       class="user-link">
                                        <span class="user-avatar">ğŸ‘¤</span>
                                        {{ apuesta.user.username }}
                                    </a>
                                </td>
                                <td class="cyber-td">
                                    <span class="game-badge game-{{ apuesta.juego }}">
                                        {% if apuesta.juego == 'blackjack' %}ğŸ²
                                        {% elif apuesta.juego == 'poker' %}ğŸƒ
                                        {% elif apuesta.juego == 'coinflip' %}ğŸª™
                                        {% elif apuesta.juego == 'tragaperras' %}ğŸ°
                                        {% elif apuesta.juego == 'caballos' %}ğŸ‡
                                        {% elif apuesta.juego == 'ruleta' %}ğŸ¯
                                        {% else %}ğŸ®{% endif %}
                                        {{ apuesta.juego|title }}
                                    </span>
                                </td>
                                <td class="cyber-td">
                                    <span class="amount">${{ "%.2f"|format(apuesta.cantidad) }}</span>
                                </td>
                                <td class="cyber-td">
                                    <span class="result-badge result-{{ apuesta.resultado }}">
                                        {{ apuesta.resultado|title }}
                                    </span>
                                </td>
                                <td class="cyber-td">
                                    <span class="{% if apuesta.ganancia > 0 %}profit{% elif apuesta.ganancia < 0 %}loss{% else %}neutral{% endif %}">
                                        ${{ "%.2f"|format(apuesta.ganancia) }}
                                    </span>
                                </td>
                                <td class="cyber-td">
                                    <span class="timestamp">{{ apuesta.fecha.strftime('%d/%m/%Y %H:%M') }}</span>
                                </td>
                                <td class="cyber-td">
                                    <span class="{% if (apuesta.ganancia - apuesta.cantidad) >= 0 %}profit{% else %}loss{% endif %} net-amount">
                                        ${{ "%.2f"|format(apuesta.ganancia - apuesta.cantidad) }}
                                    </span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div class="empty-state">
                                        <div class="empty-icon">ğŸ“­</div>
                                        <h5 class="text-muted mt-3">No se encontraron apuestas</h5>
                                        <p class="text-muted mb-0">
                                            {% if juego_actual or resultado_actual %}
                                            No hay apuestas que coincidan con los filtros aplicados
                                            {% else %}
                                            No hay apuestas registradas en el sistema
                                            {% endif %}
                                        </p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- PaginaciÃ³n Mejorada -->
                {% if apuestas.pages > 1 %}
                <nav aria-label="PaginaciÃ³n de apuestas" class="mt-4">
                    <ul class="pagination cyber-pagination justify-content-center">
                        {% if apuestas.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin_apuestas.home', page=apuestas.prev_num, juego=juego_actual, resultado=resultado_actual) }}">
                                    â† Anterior
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">â† Anterior</span>
                            </li>
                        {% endif %}
                        
                        {% for page_num in apuestas.iter_pages(left_edge=1, left_current=2, right_current=2, right_edge=1) %}
                            {% if page_num %}
                                <li class="page-item {% if page_num == apuestas.page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('admin_apuestas.home', page=page_num, juego=juego_actual, resultado=resultado_actual) }}">
                                        {{ page_num }}
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if apuestas.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin_apuestas.home', page=apuestas.next_num, juego=juego_actual, resultado=resultado_actual) }}">
                                    Siguiente â†’
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Siguiente â†’</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filtros automÃ¡ticos con debounce
let filterTimeout;

function applyFilters() {
    const juego = document.getElementById('juegoFilter').value;
    const resultado = document.getElementById('resultadoFilter').value;
    
    // Construir URL con parÃ¡metros
    const params = new URLSearchParams();
    if (juego) params.set('juego', juego);
    if (resultado) params.set('resultado', resultado);
    params.set('page', '1');
    
    window.location.href = '{{ url_for("admin_apuestas.home") }}?' + params.toString();
}

function clearFilters() {
    window.location.href = '{{ url_for("admin_apuestas.home") }}';
}

// Filtro automÃ¡tico con retardo
function setupAutoFilters() {
    const selects = document.querySelectorAll('.cyber-select');
    
    selects.forEach(select => {
        select.addEventListener('change', function() {
            // Clear previous timeout
            clearTimeout(filterTimeout);
            
            // Show loading state
            const cardBody = document.querySelector('.card-body');
            cardBody.style.opacity = '0.7';
            
            // Apply filters after short delay
            filterTimeout = setTimeout(() => {
                applyFilters();
            }, 500);
        });
    });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    setupAutoFilters();
});
</script>

<style>
/* Estilos mejorados para la gestiÃ³n de apuestas */
.glass-card {
    background: rgba(20, 20, 40, 0.7);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(0, 243, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 243, 255, 0.1);
}

.cyber-header {
    background: linear-gradient(135deg, rgba(0, 243, 255, 0.2), rgba(138, 43, 226, 0.2));
    border-bottom: 1px solid rgba(0, 243, 255, 0.3);
}

.stat-card {
    background: rgba(30, 30, 60, 0.6);
    border: 1px solid rgba(0, 243, 255, 0.2);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    border-color: var(--neon-cyan);
    box-shadow: 0 5px 20px rgba(0, 243, 255, 0.3);
}

.stat-icon {
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
    opacity: 0.8;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: bold;
    font-family: var(--font-family-title);
    background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Filtros mejorados */
.filter-group {
    position: relative;
}

.filter-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--neon-cyan);
    margin-bottom: 0.5rem;
    display: block;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.cyber-select {
    background: rgba(15, 15, 30, 0.8);
    border: 1px solid rgba(0, 243, 255, 0.4);
    border-radius: 8px;
    color: var(--text-light);
    transition: all 0.3s ease;
}

.cyber-select:focus {
    border-color: var(--neon-cyan);
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
    background: rgba(20, 20, 40, 0.9);
}

/* Tabla mejorada */
.table-cyber {
    --bs-table-bg: transparent;
    --bs-table-border-color: rgba(0, 243, 255, 0.2);
}

.cyber-thead {
    background: linear-gradient(135deg, rgba(0, 243, 255, 0.1), rgba(138, 43, 226, 0.1));
}

.cyber-th {
    color: var(--neon-cyan);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 1px;
    border-bottom: 2px solid var(--neon-cyan);
    padding: 1rem 0.75rem;
}

.cyber-row {
    transition: all 0.3s ease;
    border-bottom: 1px solid rgba(0, 243, 255, 0.1);
}

.cyber-row:hover {
    background: rgba(0, 243, 255, 0.05);
    transform: translateX(5px);
}

.cyber-td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
    border-color: rgba(0, 243, 255, 0.1);
}

/* Elementos de la tabla */
.id-badge {
    background: rgba(0, 243, 255, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.8rem;
    color: var(--neon-cyan);
    font-family: var(--font-family-title);
}

.user-link {
    color: var(--text-light);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.user-link:hover {
    color: var(--neon-cyan);
    transform: translateX(3px);
}

.user-avatar {
    font-size: 1rem;
}

.game-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.game-blackjack { background: rgba(0, 123, 255, 0.2); color: #007bff; border: 1px solid #007bff; }
.game-poker { background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid #28a745; }
.game-coinflip { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid #ffc107; }
.game-tragaperras { background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid #dc3545; }
.game-caballos { background: rgba(23, 162, 184, 0.2); color: #17a2b8; border: 1px solid #17a2b8; }
.game-ruleta { background: rgba(108, 117, 125, 0.2); color: #6c757d; border: 1px solid #6c757d; }

.result-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.result-ganada { background: rgba(0, 255, 136, 0.2); color: var(--neon-green); border: 1px solid var(--neon-green); }
.result-perdida { background: rgba(255, 107, 53, 0.2); color: var(--neon-orange); border: 1px solid var(--neon-orange); }
.result-empate { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid #ffc107; }

.amount {
    font-weight: 600;
    color: var(--text-light);
}

.profit {
    color: var(--neon-green);
    font-weight: 700;
}

.loss {
    color: var(--neon-orange);
    font-weight: 700;
}

.neutral {
    color: #ffc107;
    font-weight: 700;
}

.net-amount {
    font-size: 1rem;
}

.timestamp {
    font-size: 0.85rem;
    color: #888;
    font-family: var(--font-family-title);
}

/* Estados vacÃ­os */
.empty-state {
    padding: 3rem 1rem;
}

.empty-icon {
    font-size: 4rem;
    opacity: 0.5;
}

/* Badges personalizados */
.badge.bg-pulse {
    background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
    animation: pulse 2s infinite;
}

.badge.bg-cyan {
    background: var(--neon-cyan);
    color: #000;
}

.badge.bg-game {
    background: rgba(0, 243, 255, 0.2);
    color: var(--neon-cyan);
    border: 1px solid var(--neon-cyan);
}

.badge.bg-result {
    background: rgba(255, 0, 255, 0.2);
    color: var(--neon-pink);
    border: 1px solid var(--neon-pink);
}

.alert-cyber {
    background: rgba(0, 243, 255, 0.1);
    border: 1px solid rgba(0, 243, 255, 0.3);
    border-radius: 12px;
    color: var(--neon-cyan);
}

/* PaginaciÃ³n mejorada */
.cyber-pagination .page-link {
    background: rgba(20, 20, 40, 0.8);
    border: 1px solid rgba(0, 243, 255, 0.3);
    color: var(--neon-cyan);
    margin: 0 2px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.cyber-pagination .page-item.active .page-link {
    background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
    border-color: var(--neon-cyan);
    color: #000;
    font-weight: 700;
}

/* Animaciones */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Responsive */
@media (max-width: 768px) {
    .cyber-td, .cyber-th {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
    }
    
    .game-badge, .result-badge {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
    }
}
</style>
{% endblock %}