<!DOCTYPE html>
<html lang="es" data-mode="bet">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ruleta Multijugador üéØ</title>
  <style>
    :root{
      --felt:#1a2240; --felt-dark:#151b34; --gold:#e0b14a; --cream:#f3efe2; --shadow:0 6px 18px rgba(0,0,0,.22);
      --tile:#202a55; --tile-outer:#1e264c; --text:#e8ecff; --badge-bg:rgba(255,255,255,.92); --badge-fg:#10121f;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; background: radial-gradient(900px 600px at 60% 30%, #0f1330, var(--felt-dark)); color:var(--text); display:flex; flex-direction:column; gap:10px;}
    header{ padding:12px 16px; color:var(--cream); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .pill{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); padding:6px 10px; border-radius:999px; font-size:12px;}
    main{display:grid; gap:18px; padding:0 16px 16px; max-width:1400px; width:100%; margin:0 auto; grid-template-columns: 380px 1fr;}
    .panel{background:linear-gradient(180deg, var(--felt), var(--felt-dark)); border:2px solid rgba(255,255,255,.12); border-radius:18px; padding:14px; box-shadow:var(--shadow)}
    .wheel-wrap{display:grid; place-items:center}
    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center; justify-content:center}
    .btn{appearance:none; border:none; padding:10px 14px; border-radius:12px; background:var(--gold); color:#1a1a1a; font-weight:700; cursor:pointer; box-shadow:var(--shadow)}
    .btn:disabled{opacity:0.5; cursor:not-allowed;}
    .btn.secondary{background:#e5e7ff; color:#10121f}
    .wheel-wrap svg{ width:100%; height:auto; display:block; max-width:460px; }
    .table{display:grid; grid-template-columns: 90px repeat(12, 1fr) 140px 140px; gap:5px; padding:10px; background:var(--felt); border-radius:14px; border:1px solid rgba(255,255,255,.15)}
    .cell{position:relative; background:var(--tile); border:1px solid rgba(0,0,0,.35); color:#fafafa; text-align:center; padding:22px 8px; border-radius:10px; user-select:none; font-size:28px; font-weight:900}
    .cell.zero{grid-row: 1 / span 3; background:#1d6f3e; display:flex; align-items:center; justify-content:center}
    .cell.red{background:#9e1f24} .cell.black{background:#0b0b0b}
    .cell.preview{ outline:3px solid rgba(255,215,0,0.85); box-shadow:0 6px 18px rgba(255,215,0,0.12) }
    .outside{ background:var(--tile-outer); font-weight:800; font-size:18px }
    .bet-badge{position:absolute; right:8px; bottom:8px; background:var(--badge-bg); color:var(--badge-fg); padding:2px 8px; border-radius:999px; font-size:13px; font-weight:900}
    .chips{display:flex; gap:10px; flex-wrap:wrap; align-items:center; padding:10px}
    .chip{width:56px; height:56px; border-radius:50%; display:grid; place-items:center; font-weight:900; box-shadow:var(--shadow); border:6px dotted rgba(0,0,0,.25); cursor:grab; color:#000}
    .group{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.15); border-radius:14px; padding:10px; margin-top:12px}
    .log{height:150px; overflow:auto; background:#0f1535; color:#eafdf0; padding:10px; border-radius:12px; font-family:ui-monospace,Consolas,monospace; font-size:11px;}
    .right-panel{display:flex; flex-direction:column; gap:10px;}
    .room-info{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;}
    .players-list{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:10px; max-height:150px; overflow-y:auto;}
    .player-item{padding:6px; background:rgba(255,255,255,.03); border-radius:8px; border-left:3px solid var(--gold); margin:4px 0; font-size:12px;}
    .player-item.ready{border-left-color:#81c784;}
    .chat-box{display:flex; flex-direction:column; gap:6px;}
    .chat-messages{background:#0f1535; border-radius:10px; padding:8px; max-height:120px; overflow-y:auto; font-size:11px; color:#eafdf0;}
    .chat-msg{margin:2px 0; padding:2px 0; border-bottom:1px solid rgba(255,255,255,.08);}
    .chat-system{color:#b3e5fc; font-style:italic;}
    .chat-input-row{display:flex; gap:4px;}
    .chat-input-row input{flex:1; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.3); color:var(--cream); font-size:11px;}
    .chat-input-row button{padding:6px 12px; background:var(--gold); color:#000; border:none; border-radius:6px; cursor:pointer; font-weight:700; font-size:10px;}
    .countdown{font-size:18px; font-weight:900; color:var(--gold); text-align:center; padding:8px; background:rgba(0,0,0,.3); border-radius:8px; margin:10px 0;}
  </style>
</head>
<body data-mode="bet">
  <header>
    <div style="font-weight:800; font-size:18px">üéØ Ruleta Multijugador</div>
    <div class="room-info">
      <span class="pill">Sala: <b id="room-name">‚Äî</b></span>
      <span class="pill">Jugadores: <b id="players-count">0</b>/<span id="room-capacity">2</span></span>
      <span class="pill">Banco: <b id="balance-user">0.00</b>‚Ç¨</span>
      <span class="pill">Apuesta: <b id="betTotal">0</b>¬¢</span>
    </div>
  </header>

  <main>
    <section class="panel wheel-wrap">
      <svg id="wheel" viewBox="-220 -220 440 440" aria-label="ruleta">
        <defs>
          <radialGradient id="rim" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#c08a26"/>
            <stop offset="70%" stop-color="#8a5e10"/>
            <stop offset="100%" stop-color="#5a3b08"/>
          </radialGradient>
        </defs>
        <circle r="210" fill="url(#rim)"/>
        <g id="numbers"></g>
        <circle r="110" fill="#2f7a3d"/>
        <circle r="20" fill="#1a4a25"/>
        <circle id="ball" r="6" fill="#f3efe2" cx="0" cy="-170"/>
      </svg>
      <div class="controls">
        <button id="spinBtn" class="btn" disabled>Girar</button>
        <button id="clearBtn" class="btn secondary">Borrar jugada</button>
        <button id="undoBtn" class="btn secondary">Deshacer</button>
        <button id="confirmBetBtn" class="btn">Confirmar apuesta</button>
      </div>
      <div class="countdown" id="countdown-display" style="display:none;">
        Tiempo: <span id="countdown-timer">30</span>s
      </div>
    </section>

    <div class="right-panel">
      <section class="panel">
        <div class="chips" id="chips">
          <div class="chip" draggable="true" data-value="20">0,20‚Ç¨</div>
          <div class="chip" draggable="true" data-value="50">0,50‚Ç¨</div>
          <div class="chip" draggable="true" data-value="100">1‚Ç¨</div>
          <div class="chip" draggable="true" data-value="200">2‚Ç¨</div>
          <div class="chip" draggable="true" data-value="500">5‚Ç¨</div>
          <div class="chip" draggable="true" data-value="1000">10‚Ç¨</div>
        </div>

        <div class="bets-buttons" style="margin:8px 0 4px;">
          <button class="btn" id="voisinsBtn">Vecinos 0</button>
          <button class="btn" id="tiersBtn">Tiers</button>
          <button class="btn" id="orphBtn">Hu√©rfanos</button>
        </div>

        <div class="table" id="layout"></div>

        <div class="group">
          <h3 style="margin:6px 6px 10px;">Apuestas exteriores</h3>
          <div class="bets-buttons">
            <button class="btn" data-out="red">Rojo</button>
            <button class="btn" data-out="black">Negro</button>
            <button class="btn" data-out="even">Par</button>
            <button class="btn" data-out="odd">Impar</button>
            <button class="btn" data-out="low">1‚Äì18</button>
            <button class="btn" data-out="high">19‚Äì36</button>
            <button class="btn" data-out="d1">1¬™ Docena</button>
            <button class="btn" data-out="d2">2¬™ Docena</button>
            <button class="btn" data-out="d3">3¬™ Docena</button>
            <button class="btn" data-out="c1">Columna 1</button>
            <button class="btn" data-out="c2">Columna 2</button>
            <button class="btn" data-out="c3">Columna 3</button>
          </div>
        </div>

        <div class="log" id="log"></div>
      </section>

      <section class="panel">
        <h3 style="margin:0 0 10px;">Jugadores</h3>
        <div class="players-list" id="players-list"></div>
      </section>

      <section class="panel">
        <h3 style="margin:0 0 8px;">Chat</h3>
        <div class="chat-box">
          <div class="chat-messages" id="chat-messages"></div>
          <div class="chat-input-row">
            <input type="text" id="chat-input" placeholder="Mensaje..." />
            <button id="chat-send">Enviar</button>
          </div>
        </div>
      </section>
    </div>
  </main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>

<script>
/* ================== CONFIG ================== */
const EURO_SEQ = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const REDS = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
const ALL = Array.from({length:36},(_,i)=>i+1);
const PAYOUT = { straight:35, split:17, street:11, corner:8, line:5, dozen:2, column:2, even:1 };
const CHIP_COLORS=new Map([[20,'#ffd54f'],[50,'#4fc3f7'],[100,'#81c784'],[200,'#ba68c8'],[500,'#ff8a65'],[1000,'#e57373']]);

/* ================== STATE ================== */
const salaId = {{ sala.id|tojson }};
const userId = {{ current_user.id|tojson }};
let myBalance = {{ current_user.balance|tojson|int }} * 100; // convertir a centavos

let bets = []; 
let history = [];
let lastBets = [];
let spinning = false;
let countdownInterval = null;
let countdownRemaining = 30;
let serverSpinning = false;

const socket = io();

/* ================== LOG & FORMAT ================== */
function centsToEuro(c){ return (c/100).toLocaleString('es-ES',{style:'currency',currency:'EUR'}); }
function log(t){ const p=document.createElement('div'); p.innerHTML=t; document.getElementById('log').prepend(p); }
function pickChipColor(v){ if(CHIP_COLORS.has(v)) return CHIP_COLORS.get(v); if(v<50)return'#ffd54f'; if(v<100)return'#4fc3f7'; if(v<200)return'#81c784'; if(v<500)return'#ba68c8'; if(v<1000)return'#ff8a65'; return'#e57373';}

/* ================== SVG RUEDA ================== */
function initWheel(){
  const gNums=document.getElementById('numbers');
  EURO_SEQ.forEach((n,idx)=>{
    const a0=(2*Math.PI/EURO_SEQ.length)*idx-Math.PI/2;
    const a1=(2*Math.PI/EURO_SEQ.length)*(idx+1)-Math.PI/2;
    const R_OUT=190;
    const x0=R_OUT*Math.cos(a0), y0=R_OUT*Math.sin(a0);
    const x1=R_OUT*Math.cos(a1), y1=R_OUT*Math.sin(a1);
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',`M ${x0.toFixed(2)} ${y0.toFixed(2)} A ${R_OUT} ${R_OUT} 0 0 1 ${x1.toFixed(2)} ${y1.toFixed(2)} L ${(R_OUT-40)*Math.cos(a1).toFixed(2)} ${(R_OUT-40)*Math.sin(a1).toFixed(2)} A ${R_OUT-40} ${R_OUT-40} 0 0 0 ${(R_OUT-40)*Math.cos(a0).toFixed(2)} ${(R_OUT-40)*Math.sin(a0).toFixed(2)} Z`);
    p.setAttribute('fill', n===0?'#0a9a4a':(REDS.has(n)?'#b72025':'#111')); 
    p.setAttribute('stroke','#222'); 
    p.setAttribute('stroke-width','1'); 
    gNums.appendChild(p);
    const label=document.createElementNS('http://www.w3.org/2000/svg','text');
    const ang=(a0+a1)/2;
    const R_TEXT=165;
    label.setAttribute('x',(R_TEXT*Math.cos(ang)).toFixed(2)); 
    label.setAttribute('y',(R_TEXT*Math.sin(ang)).toFixed(2));
    label.setAttribute('fill','#fff'); 
    label.setAttribute('font-size','14'); 
    label.setAttribute('text-anchor','middle'); 
    label.setAttribute('dominant-baseline','middle'); 
    label.textContent=String(n); 
    gNums.appendChild(label);
  });
}

/* ================== TABLERO ================== */
const indexToCell={};
function initTable(){
  const layout=document.getElementById('layout');
  const zero = cell('0','zero'); 
  zero.style.gridRow='1 / span 3'; 
  zero.style.gridColumn='1 / 2'; 
  layout.appendChild(zero);
  indexToCell[0] = zero;
  
  for(let r=0;r<3;r++){
    for(let c=0;c<12;c++){
      const n=3*c+(3-r);
      const col=REDS.has(n)?'red':'black';
      const d=cell(String(n),col);
      d.dataset.kind='straight';
      d.dataset.cover=JSON.stringify([n]);
      d.dataset.label=`${n}`;
      d.dataset.number=String(n);
      layout.appendChild(d);
      indexToCell[n]=d;
    }
  }

  const d1=outsideCell('1¬™ Docena','dozen',ALL.filter(n=>n<=12));
  const d2=outsideCell('2¬™ Docena','dozen',ALL.filter(n=>n>=13&&n<=24));
  const d3=outsideCell('3¬™ Docena','dozen',ALL.filter(n=>n>=25));
  d1.style.gridColumn='14 / 15'; d2.style.gridColumn='15 / 16'; d3.style.gridColumn='16 / 17';
  d1.style.gridRow=d2.style.gridRow=d3.style.gridRow='1 / span 3';
  layout.appendChild(d1); layout.appendChild(d2); layout.appendChild(d3);

  const c1=outsideCell('Columna 1','column',ALL.filter(n=>n%3===1));
  const c2=outsideCell('Columna 2','column',ALL.filter(n=>n%3===2));
  const c3=outsideCell('Columna 3','column',ALL.filter(n=>n%3===0));
  c1.style.gridColumn='2 / 14'; c1.style.gridRow='4 / 5';
  c2.style.gridColumn='2 / 14'; c2.style.gridRow='5 / 6';
  c3.style.gridColumn='2 / 14'; c3.style.gridRow='6 / 7';
  layout.appendChild(c1); layout.appendChild(c2); layout.appendChild(c3);

  const simpleRow=document.createElement('div');
  simpleRow.style.gridColumn='14 / 17'; simpleRow.style.gridRow='4 / 7';
  simpleRow.style.display='grid'; simpleRow.style.gridTemplateColumns='repeat(2, 1fr)'; simpleRow.style.gap='6px';
  ['Rojo','Negro','Par','Impar','1‚Äì18','19‚Äì36'].forEach(lbl=>{
    const map = {
      'Rojo':{kind:'even', set:ALL.filter(n=>REDS.has(n))},
      'Negro':{kind:'even', set:ALL.filter(n=>!REDS.has(n)&&n!==0)},
      'Par':{kind:'even', set:ALL.filter(n=>n%2===0&&n!==0)},
      'Impar':{kind:'even', set:ALL.filter(n=>n%2===1)},
      '1‚Äì18':{kind:'even', set:ALL.filter(n=>n>=1&&n<=18)},
      '19‚Äì36':{kind:'even', set:ALL.filter(n=>n>=19)}
    };
    const v=map[lbl];
    const el=outsideCell(lbl,v.kind,v.set); 
    el.style.minHeight='48px'; 
    simpleRow.appendChild(el);
  });
  layout.appendChild(simpleRow);
}

function cell(text, extra=''){ 
  const d=document.createElement('div'); 
  d.className=`cell ${extra}`.trim(); 
  d.textContent=text; 
  enableDrop(d); 
  return d; 
}

function outsideCell(text, kind, set){ 
  const d=cell(text,'outside'); 
  d.dataset.kind=kind; 
  d.dataset.cover=JSON.stringify(set); 
  d.dataset.label=text; 
  return d; 
}

/* ================== DRAG & DROP ================== */
let droppedSomewhere = false;

function enableDrop(el){
  el.ondragover=(e)=>{
    e.preventDefault();
    try{
      const rect=el.getBoundingClientRect();
      const x=(e.clientX-rect.left)/rect.width; 
      const y=(e.clientY-rect.top)/rect.height;
      const num=Number(el.dataset.number||'0');
      const target = computeTargetFromPosition(num,x,y);
      clearPreview();
      if(target) highlightPreview(target);
    }catch(err){}
  };
  el.ondragleave = (e)=>{ clearPreview(); };
  el.ondrop=(e)=>{
    e.preventDefault(); 
    droppedSomewhere=true;
    const kind=el.dataset.kind||'straight';
    const chipVal=e.dataTransfer.getData('chip');
    if(kind!=='straight'){
      const set=new Set(JSON.parse(el.dataset.cover||'[]'));
      const target={type:kind,set,label:el.dataset.label||el.textContent};
      if(chipVal){ placeBet(target, Number(chipVal)); }
      return;
    }
    const rect=el.getBoundingClientRect();
    const x=(e.clientX-rect.left)/rect.width;
    const y=(e.clientY-rect.top)/rect.height;
    const num=Number(el.dataset.number||'0');
    const target = computeTargetFromPosition(num,x,y); 
    if(!target) return;
    if(chipVal){ placeBet(target, Number(chipVal)); }
  };
}

function getRC(n){ const c=Math.ceil(n/3)-1; const r=3-((n-1)%3)-1; return {r,c}; }
function numAt(r,c){ if(r<0||r>2||c<0||c>11) return null; return 3*c + (3-r); }

function computeTargetFromPosition(n,x,y){
  const {r,c}=getRC(n);
  const centerMin = 0.25, centerMax = 0.75;
  const cornerThreshold = 0.18;

  if(x >= centerMin && x <= centerMax && y >= centerMin && y <= centerMax){
    return {type:'straight', set:new Set([n]), label:String(n)};
  }

  const nearLeftCorner = x < cornerThreshold, nearRightCorner = x > 1 - cornerThreshold;
  const nearTopCorner = y < cornerThreshold, nearBottomCorner = y > 1 - cornerThreshold;
  if(nearLeftCorner && nearTopCorner){ const a=n,b=numAt(r,c-1),c2=numAt(r-1,c),d=numAt(r-1,c-1); if(b&&c2&&d) return {type:'corner', set:new Set([a,b,c2,d]), label:`${a}-${b}-${c2}-${d}`}; }
  if(nearRightCorner && nearTopCorner){ const a=n,b=numAt(r,c+1),c2=numAt(r-1,c),d=numAt(r-1,c+1); if(b&&c2&&d) return {type:'corner', set:new Set([a,b,c2,d]), label:`${a}-${b}-${c2}-${d}`}; }
  if(nearLeftCorner && nearBottomCorner){ const a=n,b=numAt(r,c-1),c2=numAt(r+1,c),d=numAt(r+1,c-1); if(b&&c2&&d) return {type:'corner', set:new Set([a,b,c2,d]), label:`${a}-${b}-${c2}-${d}`}; }
  if(nearRightCorner && nearBottomCorner){ const a=n,b=numAt(r,c+1),c2=numAt(r+1,c),d=numAt(r+1,c+1); if(b&&c2&&d) return {type:'corner', set:new Set([a,b,c2,d]), label:`${a}-${b}-${c2}-${d}`}; }

  const centerBandX = x >= centerMin && x <= centerMax;
  const centerBandY = y >= centerMin && y <= centerMax;
  if(x < centerMin && centerBandY){ const b = numAt(r, c-1); if(b) return {type:'split', set:new Set([n,b]), label:`${n}-${b}`}; }
  if(x > centerMax && centerBandY){ const b = numAt(r, c+1); if(b) return {type:'split', set:new Set([n,b]), label:`${n}-${b}`}; }
  if(y < centerMin && centerBandX){ const b = numAt(r-1, c); if(b) return {type:'split', set:new Set([n,b]), label:`${n}-${b}`}; }
  if(y > centerMax && centerBandX){ const b = numAt(r+1, c); if(b) return {type:'split', set:new Set([n,b]), label:`${n}-${b}`}; }

  if(centerBandX && y < centerMin){ const a=numAt(0,c), b=numAt(1,c), d=numAt(2,c); if(a&&b&&d) return {type:'street', set:new Set([a,b,d]), label:`${a}-${b}-${d}`}; }
  if(centerBandX && y > centerMax){ const a=numAt(0,c), b=numAt(1,c), d=numAt(2,c); if(a&&b&&d) return {type:'street', set:new Set([a,b,d]), label:`${a}-${b}-${d}`}; }

  return {type:'straight', set:new Set([n]), label:String(n)};
}

function clearPreview(){ 
  document.querySelectorAll('.cell.preview').forEach(el=>el.classList.remove('preview')); 
}

function highlightPreview(target){ 
  try{
    const nums = [...target.set]; 
    nums.forEach(n=>{ const el = indexToCell[n]; if(el) el.classList.add('preview'); });
  }catch(e){}
}

/* ================== BETS ================== */
function placeBet(target, chipValue){
  const bet = {
    type: target.type,
    set: [...target.set],
    label: target.label,
    amount: chipValue
  };
  bets.push(bet);
  history.push({bets: JSON.parse(JSON.stringify(bets))});
  updateBetsDisplay();
  clearPreview();
}

function updateBetsDisplay(){
  let total = 0;
  bets.forEach(b => total += b.amount);
  document.getElementById('betTotal').textContent = total;
  bets.forEach(bet => {
    const nums = bet.set;
    nums.forEach(n => {
      const el = indexToCell[n];
      if (el) {
        let badge = el.querySelector('.bet-badge');
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'bet-badge';
          el.appendChild(badge);
        }
        badge.textContent = (bet.amount / 100).toFixed(2) + '‚Ç¨';
      }
    });
  });
}

/* ================== SOCKET EVENTS ================== */
socket.on('connect', () => {
  console.log('‚úÖ Socket conectado');
  socket.emit('join_ruleta_room', { sala_id: salaId });
});

socket.on('estado_sala_actualizado', (data) => {
  if (!data || data.sala_id !== salaId) return;
  document.getElementById('room-name').textContent = data.room_name || 'Sala';
  document.getElementById('players-count').textContent = data.jugadores ? data.jugadores.length : 0;
  document.getElementById('room-capacity').textContent = data.capacity || 2;
  
  updatePlayersList(data.jugadores || []);
  
  if (data.apuestas_count > 0 && !countdownInterval) {
    startCountdown();
  }
});

socket.on('apuesta_recibida', (data) => {
  if (!data || data.sala_id !== salaId) return;
  log(`<span style="color:#b3e5fc;font-style:italic;">‚úÖ Apuesta recibida y guardada de forma privada</span>`);
});

socket.on('spin_ack', (data) => {
  if (!data) return;
  if (data.spun === false) {
    log(`<span style="color:#ff9800;">‚è≥ Esperando: ${data.players_ready}/${data.players_needed}</span>`);
    document.getElementById('spinBtn').disabled = false;
  }
});

socket.on('ruleta_girada', (data) => {
  console.log('üé∞ Ruleta girada:', data);
  stopCountdown();
  clearBets();
  spinning = false;
  document.getElementById('spinBtn').disabled = false;
  
  if (data && data.result !== undefined) {
    animateSpin(data.result);
    log(`<span style="color:#81c784;font-weight:bold;">üé≤ Resultado: ${data.result}</span>`);
    
    if (data.results && Array.isArray(data.results)) {
      const my = data.results.find(r => r.usuario_id == userId);
      if (my) {
        myBalance = Math.round(my.nuevo_balance * 100);
        document.getElementById('balance-user').textContent = (my.nuevo_balance).toFixed(2);
        const winMsg = my.win_euros > 0 ? `‚úÖ ¬°Ganancia: ${my.win_euros.toFixed(2)}‚Ç¨!` : `‚ùå P√©rdida: ${Math.abs(my.win_euros).toFixed(2)}‚Ç¨`;
        log(`<span style="color:#b3e5fc;">${winMsg}</span>`);
      }
      data.results.forEach(r => {
        if (r.usuario_id !== userId) {
          log(`<span style="color:#90caf9;">${r.username || r.usuario_id}: ${(r.payout_euros).toFixed(2)}‚Ç¨ payout</span>`);
        }
      });
    }
  }
});

socket.on('new_ruleta_message', (data) => {
  if (!data) return;
  addChatMessage(data.username || data.user_id, data.message, 'user');
});

/* ================== COUNTDOWN ================== */
function startCountdown(){
  if (countdownInterval) return;
  countdownRemaining = 30;
  document.getElementById('countdown-display').style.display = 'block';
  updateCountdownDisplay();
  
  countdownInterval = setInterval(() => {
    countdownRemaining--;
    if (countdownRemaining < 0) countdownRemaining = 0;
    updateCountdownDisplay();
    
    if (countdownRemaining === 0) {
      clearInterval(countdownInterval);
      countdownInterval = null;
      log(`<span style="color:#ff6b6b;font-weight:bold;">‚è∞ 30s alcanzados - Giro autom√°tico</span>`);
      socket.emit('ruleta_spin', { sala_id: salaId });
    }
  }, 1000);
}

function stopCountdown(){
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
  document.getElementById('countdown-display').style.display = 'none';
}

function updateCountdownDisplay(){
  document.getElementById('countdown-timer').textContent = countdownRemaining;
}

/* ================== ANIMATIONS ================== */
function animateSpin(result){
  const wheel = document.getElementById('wheel');
  const ball = document.getElementById('ball');
  const idx = EURO_SEQ.indexOf(result);
  const angle = (360 / EURO_SEQ.length) * idx;
  wheel.style.transition = 'none';
  wheel.style.transform = 'rotate(0deg)';
  
  setTimeout(() => {
    wheel.style.transition = 'transform 4s cubic-bezier(0.25, 0.1, 0.25, 1)';
    wheel.style.transform = `rotate(${-angle - 1800}deg)`;
  }, 50);
}

/* ================== UI HANDLERS ================== */
document.getElementById('clearBtn').addEventListener('click', () => {
  clearBets();
});

document.getElementById('undoBtn').addEventListener('click', () => {
  if (history.length > 0) {
    history.pop();
    bets = history.length > 0 ? JSON.parse(JSON.stringify(history[history.length - 1].bets)) : [];
    updateBetsDisplay();
  }
});

document.getElementById('confirmBetBtn').addEventListener('click', () => {
  if (bets.length === 0) {
    alert('Coloca al menos una apuesta');
    return;
  }
  const totalBet = bets.reduce((sum, b) => sum + b.amount, 0);
  if (totalBet > myBalance) {
    alert('Saldo insuficiente');
    return;
  }
  
  myBalance -= totalBet;
  document.getElementById('balance-user').textContent = (myBalance / 100).toFixed(2);
  
  const betSnapshot = bets.map(b => ({
    type: b.type,
    set: b.set,
    label: b.label,
    amount: b.amount
  }));
  
  socket.emit('ruleta_place_bet', { 
    sala_id: salaId, 
    bets: betSnapshot
  });
  
  log(`<span style="color:#ffd54f;font-weight:bold;">üí∞ Apuesta de ${(totalBet / 100).toFixed(2)}‚Ç¨ enviada (privada)</span>`);
  lastBets = JSON.parse(JSON.stringify(bets));
  clearBets();
  
  document.getElementById('spinBtn').disabled = false;
  startCountdown();
});

document.getElementById('spinBtn').addEventListener('click', () => {
  if (bets.length > 0) {
    alert('Confirma tu apuesta primero');
    return;
  }
  spinning = true;
  document.getElementById('spinBtn').disabled = true;
  log(`<span style="color:#ffd54f;">üéØ Presionaste Girar...</span>`);
  socket.emit('ruleta_spin', { sala_id: salaId });
});

document.getElementById('voisinsBtn').addEventListener('click', () => {
  const neighbours = [26, 0, 32, 15, 19];
  neighbours.forEach(n => placeBet({type: 'straight', set: [n], label: String(n)}, 200));
});

document.getElementById('tiersBtn').addEventListener('click', () => {
  const tiers = [27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33];
  tiers.forEach((n, i) => {
    if (i % 2 === 0 && i + 1 < tiers.length) {
      placeBet({type: 'split', set: [tiers[i], tiers[i+1]], label: `${tiers[i]}-${tiers[i+1]}`}, 100);
    }
  });
});

document.getElementById('orphBtn').addEventListener('click', () => {
  const orphans = [6, 34, 17, 1, 20, 14, 31, 9];
  orphans.forEach((n, i) => {
    if (i % 2 === 0 && i + 1 < orphans.length) {
      placeBet({type: 'split', set: [orphans[i], orphans[i+1]], label: `${orphans[i]}-${orphans[i+1]}`}, 100);
    }
  });
});

document.querySelectorAll('.bets-buttons button[data-out]').forEach(btn => {
  btn.addEventListener('click', () => {
    const out = btn.dataset.out;
    const maps = {
      'red': {type: 'even', set: ALL.filter(n => REDS.has(n)), label: 'Rojo'},
      'black': {type: 'even', set: ALL.filter(n => !REDS.has(n) && n !== 0), label: 'Negro'},
      'even': {type: 'even', set: ALL.filter(n => n % 2 === 0), label: 'Par'},
      'odd': {type: 'even', set: ALL.filter(n => n % 2 === 1), label: 'Impar'},
      'low': {type: 'even', set: ALL.filter(n => n >= 1 && n <= 18), label: '1‚Äì18'},
      'high': {type: 'even', set: ALL.filter(n => n >= 19), label: '19‚Äì36'},
      'd1': {type: 'dozen', set: ALL.filter(n => n <= 12), label: '1¬™ Docena'},
      'd2': {type: 'dozen', set: ALL.filter(n => n >= 13 && n <= 24), label: '2¬™ Docena'},
      'd3': {type: 'dozen', set: ALL.filter(n => n >= 25), label: '3¬™ Docena'},
      'c1': {type: 'column', set: ALL.filter(n => n % 3 === 1), label: 'Columna 1'},
      'c2': {type: 'column', set: ALL.filter(n => n % 3 === 2), label: 'Columna 2'},
      'c3': {type: 'column', set: ALL.filter(n => n % 3 === 0), label: 'Columna 3'}
    };
    const target = maps[out];
    if (target) placeBet(target, 100);
  });
});

/* ================== CHAT ================== */
function addChatMessage(user, msg, type='user'){
  const container = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = `chat-msg ${type === 'system' ? 'chat-system' : ''}`;
  div.innerHTML = `<strong>${user}:</strong> ${msg}`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

document.getElementById('chat-send').addEventListener('click', () => {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  socket.emit('ruleta_chat', { sala_id: salaId, message: msg });
  addChatMessage('T√∫', msg, 'user');
  input.value = '';
});

document.getElementById('chat-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') document.getElementById('chat-send').click();
});

/* ================== PLAYERS LIST ================== */
function updatePlayersList(players){
  const list = document.getElementById('players-list');
  list.innerHTML = '';
  players.forEach(p => {
    const div = document.createElement('div');
    div.className = `player-item ${p.ready ? 'ready' : ''}`;
    div.innerHTML = `<strong>${p.username}</strong> ${p.ready ? '‚úÖ Ready' : '‚è≥ Waiting'}`;
    list.appendChild(div);
  });
}

/* ================== HELPERS ================== */
function clearBets(){
  bets = [];
  document.querySelectorAll('.bet-badge').forEach(b => b.remove());
  document.getElementById('betTotal').textContent = '0';
}

/* ================== INIT ================== */
document.addEventListener('DOMContentLoaded', () => {
  initWheel();
  initTable();
  document.getElementById('balance-user').textContent = (myBalance / 100).toFixed(2);
  log(`<span style="color:#81c784;">‚úÖ Conectado a sala</span>`);
});
</script>

</body>
</html>