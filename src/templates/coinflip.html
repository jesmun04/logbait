{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-8">
    <div class="card game-card">
      <div class="card-header">
        <i class="fas fa-coins me-2"></i>
        Cara o Cruz
      </div>
      <div class="card-body">
        <!-- Panel de informaci贸n -->
        <div class="row mb-4">
          <div class="col-md-4 text-center">
            <div class="text-muted">Saldo</div>
            <h3>$<span id="balance">{{ "%.2f"|format(current_user.balance) }}</span></h3>
          </div>
          <div class="col-md-4 text-center">
            <div class="text-muted">Estado</div>
            <h3 id="estado-sistema" class="text-info">En espera</h3>
          </div>
          <div class="col-md-4 text-center">
            <div class="text-muted">ltimo resultado</div>
            <h3 id="ultimo-resultado" class="text-secondary">$0.00</h3>
          </div>
        </div>

        <!-- Controles -->
        <div class="row mb-4">
          <div class="col-md-6 mb-3">
            <label class="form-label">
              <i class="fas fa-money-bill-wave me-2"></i> Apuesta
            </label>
            <div class="input-group">
              <span class="input-group-text bg-dark text-light">
                <i class="fas fa-dollar-sign"></i>
              </span>
              <input type="number" id="cantidad" class="form-control" min="1" max="{{ current_user.balance }}" value="10">
              <button class="btn btn-outline-primary" onclick="apuestaRapida(25)">25</button>
              <button class="btn btn-outline-primary" onclick="apuestaRapida(50)">50</button>
              <button class="btn btn-outline-primary" onclick="apuestaRapida(100)">100</button>
            </div>
          </div>

          <div class="col-md-6 text-center">
            <label class="form-label">
              <i class="fas fa-hand-pointer me-2"></i>Elige tu lado
            </label>
            <div>
              <button class="btn btn-outline-danger btn-lg me-2" id="btn-cara" onclick="seleccionarLado('cara')">
                <i class="fas fa-crown me-2"></i>Cara
              </button>
              <button class="btn btn-outline-success btn-lg" id="btn-cruz" onclick="seleccionarLado('cruz')">
                <i class="fas fa-leaf me-2"></i>Cruz
              </button>
            </div>
          </div>
        </div>

        <!-- Moneda - un 煤nico nodo que ser谩 movido al overlay -->
        <div class="text-center my-5">
          <div id="moneda-wrapper" class="coin-wrapper">
            <div id="moneda" class="coin" onclick="lanzarMoneda()">
              <!-- FRONT FACE -->
              <div class="face front">
                <div class="face-inner">
                  <div class="emoji"></div>
                  <div class="label">CARA</div>
                </div>
              </div>
              <!-- BACK FACE -->
              <div class="face back">
                <div class="face-inner">
                  <div class="emoji"></div>
                  <div class="label">CRUZ</div>
                </div>
              </div>
            </div>
          </div>
          <div id="estado-moneda" class="mt-3 text-muted">Selecciona cara o cruz</div>
        </div>

        <!-- Overlay vac铆o inicialmente; la moneda se mover谩 dentro -->
        <div id="coin-overlay" class="coin-overlay d-none" aria-hidden="true">
          <div class="overlay-center" id="overlay-center"></div>
          <div id="overlay-status-container" class="overlay-status-container"></div>
        </div>

        <div class="text-center">
          <button id="btn-lanzar" class="btn btn-primary btn-lg" onclick="lanzarMoneda()">
            <i class="fas fa-rocket me-2"></i>Lanzar moneda
          </button>
        </div>

        <div id="resultado" class="mt-4"></div>

        <div class="mt-4">
          <h5>Historial de jugadas</h5>
          <ul id="historial" class="list-group small"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
/* ---------- Juego: variables ---------- */
let ladoSeleccionado = null;
let enLanzamiento = false;
const historial = [];

/* Accesos DOM */
const moneda = () => document.getElementById('moneda');
const monedaWrapper = () => document.getElementById('moneda-wrapper');
const overlay = () => document.getElementById('coin-overlay');

/* ---------- Utilidades ---------- */
function apuestaRapida(cantidad) {
  document.getElementById('cantidad').value = cantidad;
}

/* Selecci贸n de lado (sin tocar la l贸gica del juego) */
function seleccionarLado(lado) {
  if (enLanzamiento) return;

  const btnCara = document.getElementById('btn-cara');
  const btnCruz = document.getElementById('btn-cruz');

  if (ladoSeleccionado === lado) {
    ladoSeleccionado = null;
    btnCara.classList.replace('btn-danger', 'btn-outline-danger');
    btnCruz.classList.replace('btn-success', 'btn-outline-success');
    document.getElementById('estado-moneda').textContent = 'Selecciona cara o cruz';
    return;
  }

  ladoSeleccionado = lado;
  btnCara.classList.toggle('btn-danger', lado === 'cara');
  btnCara.classList.toggle('btn-outline-danger', lado !== 'cara');
  btnCruz.classList.toggle('btn-success', lado === 'cruz');
  btnCruz.classList.toggle('btn-outline-success', lado !== 'cruz');
  document.getElementById('estado-moneda').textContent = `Has elegido ${lado.toUpperCase()}`;
}

/* ---------- Animaci贸n / flujo de lanzamiento (no altera la l贸gica) ---------- */
function lanzarMoneda() {
  const cantidad = parseFloat(document.getElementById('cantidad').value);
  const balanceActual = parseFloat(document.getElementById('balance').textContent);

  if (!ladoSeleccionado) return alert("Selecciona cara o cruz antes de lanzar.");
  if (cantidad <= 0 || isNaN(cantidad)) return alert("Introduce una apuesta v谩lida.");
  if (cantidad > balanceActual) return alert("Saldo insuficiente.");
  if (enLanzamiento) return;

  enLanzamiento = true;
  document.getElementById('btn-lanzar').disabled = true;
  document.getElementById('estado-sistema').textContent = 'Lanzando...';
  document.getElementById('estado-moneda').textContent = 'La moneda est谩 girando...';

  // Preparar overlay y mover la moneda dentro
  const o = overlay();
  const m = moneda();
  const originalParent = monedaWrapper();

  // Ocultar visualmente el "lugar" original para evitar doble visual
  originalParent.style.visibility = 'hidden';

  // Mostrar overlay con fade-in
  o.classList.remove('d-none');
  o.style.opacity = '0';
  o.style.transition = 'opacity 0.45s ease';
  // A帽adimos un contenedor dentro del overlay para centrar
  o.innerHTML = `
    <div class="overlay-center" id="overlay-center"></div>
    <div id="overlay-status-container" class="overlay-status-container"></div>
  `;
  requestAnimationFrame(() => {
    o.style.opacity = '1';
    o.setAttribute('aria-hidden', 'false');
  });

  // Mover el elemento de estado al overlay
  const estadoSistema = document.getElementById('estado-sistema');
  const overlayStatusContainer = o.querySelector('#overlay-status-container');
  overlayStatusContainer.appendChild(estadoSistema);

  // Mover el nodo de la moneda al overlay-center
  const overlayCenter = document.getElementById('overlay-center');
  overlayCenter.appendChild(m); // mueve el nodo DOM
  // Forzar reflow antes de arrancar animaci贸n
  void m.offsetWidth;

  // Configurar variables de animaci贸n y clases
  const resultado = Math.random() < 0.5 ? 'cara' : 'cruz';
  const vueltas = Math.floor(Math.random() * 4) + 5; // 5-8 vueltas
  m.style.setProperty('--vueltas', vueltas);
  // limpiar cualquier estado
  m.classList.remove('animating', 'show-cara', 'show-cruz', 'in-overlay');
  void m.offsetWidth;

  // Activar modo overlay (escala + glow) y lanzar animaci贸n
  m.classList.add('in-overlay');
  // Forzar reflow y luego arrancar la animaci贸n de giro concreta
  void m.offsetWidth;
  m.classList.add(resultado === 'cara' ? 'flip-cara' : 'flip-cruz');
  m.classList.add('animating');

  // Tiempo total de animaci贸n (coincide con CSS)
  const ANIM_DURATION = 3800; // ms (debe coincidir con keyframes y tus timeouts)

  setTimeout(() => {
    // Forzar orientaci贸n final ANTES de quitar clases de animaci贸n
    if (resultado === 'cara') {
      m.classList.add('show-cara');
      m.classList.remove('show-cruz');
      m.style.transform = 'rotateY(0deg)';        // <--- A帽adido
    } else {
      m.classList.add('show-cruz');
      m.classList.remove('show-cara');
      m.style.transform = 'rotateY(180deg)';      // <--- A帽adido
    }

    // Ahora s铆, eliminar las clases de animaci贸n
    m.classList.remove('flip-cara', 'flip-cruz', 'animating');

    // Iniciar el fade-out del overlay
    o.style.transition = 'opacity 0.45s ease';
    o.style.opacity = '0';
    o.setAttribute('aria-hidden', 'true');

    // Devolver moneda tras el fade-out
    setTimeout(() => {
      originalParent.appendChild(m);

      // Devolver el estado al cuerpo principal
      const infoRow = document.querySelector('.row.mb-4'); // donde est谩 el panel de info
      const colEstado = infoRow.querySelector('.text-center:nth-child(2)');
      colEstado.appendChild(estadoSistema);

      originalParent.style.visibility = 'visible';
      o.classList.add('d-none');
      o.innerHTML = '';
      m.classList.remove('in-overlay');
      // Aseguramos que la moneda conserva la orientaci贸n correcta
      if (resultado === 'cara') {
        m.style.transform = 'rotateY(0deg)';
      } else {
        m.style.transform = 'rotateY(180deg)';
      }

      ejecutarResultado(resultado, cantidad);
    }, 480);
  }, ANIM_DURATION);
}

/* ---------- L贸gica del backend (id茅ntica a antes) ---------- */
function ejecutarResultado(resultado, cantidad) {
  const gano = resultado === ladoSeleccionado;

  fetch('/api/coinflip/apostar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      cantidad: cantidad,
      eleccion: ladoSeleccionado,
      resultado_moneda: resultado
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }

    const { nuevo_balance, ganancia } = data;
    const balanceSpan = document.getElementById('balance');
    const balanceAntiguo = parseFloat(balanceSpan.textContent);
    balanceSpan.textContent = nuevo_balance.toFixed(2);

    balanceSpan.style.transition = 'color 0.5s';
    balanceSpan.style.color = nuevo_balance > balanceAntiguo ? 'limegreen' : 'red';
    setTimeout(() => (balanceSpan.style.color = ''), 800);

    document.getElementById('ultimo-resultado').textContent = `$${ganancia.toFixed(2)}`;
    document.getElementById('ultimo-resultado').style.color = gano ? 'green' : 'red';

    mostrarResultado(gano, resultado, cantidad, ganancia);
  })
  .finally(() => {
    enLanzamiento = false;
    document.getElementById('btn-lanzar').disabled = false;
  });
}

function mostrarResultado(gano, resultado, cantidad, ganancia) {
  const div = document.getElementById('resultado');
  div.innerHTML = gano
    ? `<div class="alert alert-success text-center">
          隆Has ganado! Sali贸 ${resultado.toUpperCase()} <br>
         <strong>Ganancia: $${ganancia.toFixed(2)}</strong>
       </div>`
    : `<div class="alert alert-danger text-center">
          Has perdido. Sali贸 ${resultado.toUpperCase()} <br>
         <strong>Perdiste: $${cantidad.toFixed(2)}</strong>
       </div>`;

  historial.unshift(`${resultado.toUpperCase()} - ${gano ? 'Ganado' : 'Perdido'}`);
  if (historial.length > 5) historial.pop();
  document.getElementById('historial').innerHTML =
    historial.map(h => `<li class="list-group-item">${h}</li>`).join('');

  const btnCara = document.getElementById('btn-cara');
  const btnCruz = document.getElementById('btn-cruz');
  btnCara.classList.replace('btn-danger', 'btn-outline-danger');
  btnCruz.classList.replace('btn-success', 'btn-outline-success');

  ladoSeleccionado = null;
  document.getElementById('estado-sistema').textContent = 'En espera';
  document.getElementById('estado-moneda').textContent = 'Selecciona cara o cruz';
}
</script>

<style>
/* ----------------- Moneda: base (煤nica) ----------------- */
.coin-wrapper {
  display: inline-block;
  width: 160px;
  height: 160px;
  perspective: 1200px;
  margin: 0 auto;
}

.coin {
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
  cursor: pointer;
  transition: transform 0.6s ease;
  /* si se fija con show-cara/show-cruz, se aplica transform fijo */
}

/* Cada "face" es una cara completa, con contenido orientado normalmente.
   La cara trasera se coloca con rotateY(180deg) para que su contenido
   aparezca en orientaci贸n normal cuando el wrapper rote. */
.face {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25), inset 0 6px 14px rgba(255,255,255,0.03);
  overflow: hidden;
  border: 3px solid rgba(0,0,0,0.08);
}

/* Contenido interior para poder controlar orientaci贸n y padding */
.face-inner {
  text-align: center;
  transform: rotateY(0deg); /* fijo: el contenido no se voltea */
}

/* FRONT - CARA dorada */
.face.front {
  background: radial-gradient(circle at 30% 30%, #fff59d 0%, #ffd54f 40%, #d4af37 100%);
  color: #2b2b2b;
  border-color: #d4af37;
  transform: rotateY(0deg);
}

/* BACK - CRUZ plateada - NB: el contenido est谩 orientado correctamente porque
   la cara en s铆 est谩 rotada 180deg, pero el .face-inner no est谩 volteado */
.face.back {
  background: radial-gradient(circle at 30% 30%, #f3f4f6 0%, #c0c0c0 45%, #9d9d9d 100%);
  color: #1f1f1f;
  border-color: #a9a9a9;
  transform: rotateY(180deg);
}

/* Emoji y label */
.face .emoji {
  font-size: 3.2rem;
  line-height: 1;
  margin-bottom: 6px;
}
.face .label {
  font-family: 'Orbitron', sans-serif;
  font-weight: 700;
  letter-spacing: 1px;
  font-size: 0.9rem;
}

/* ----------------- States: show fixed face ----------------- */
.coin.show-cara {
  transform: rotateY(0deg);
}
.coin.show-cruz {
  transform: rotateY(180deg);
}

/* ----------------- In-overlay state: make coin large, centered ---------- */
/* When the coin is moved into the overlay we add .in-overlay to scale it */
.coin.in-overlay {
  width: clamp(220px, 34vw, 360px);
  height: clamp(220px, 34vw, 360px);
  transition: transform 0.25s ease, width 0.25s ease, height 0.25s ease;
}

/* Glow pulsante (overlay) */
.coin.in-overlay .face.front {
  box-shadow: 0 10px 70px rgba(255, 196, 0, 0.8);
}
.coin.in-overlay .face.back {
  box-shadow: 0 10px 70px rgba(158, 205, 255, 0.8);
}

/* --------------- Animaciones de giro (definitivas, un solo giro limpio) --------------- */
.flip-cara {
  animation: flipCaraAnim 3s ease-out forwards;
}
.flip-cruz {
  animation: flipCruzAnim 3s ease-out forwards;
}

/* Un 煤nico giro suave: rota las vueltas indicadas y se detiene */
@keyframes flipCaraAnim {
  0% {
    transform: rotateY(0deg) translateY(0) scale(1);
  }
  100% {
    transform: rotateY(calc(360deg * var(--vueltas))) translateY(0) scale(1);
  }
}

@keyframes flipCruzAnim {
  0% {
    transform: rotateY(0deg) translateY(0) scale(1);
  }
  100% {
    transform: rotateY(calc(180deg + 360deg * var(--vueltas))) translateY(0) scale(1);
  }
}

/* ----------------- Overlay styles ----------------- */
.coin-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bs-body-bg);
  z-index: 3000;
  opacity: 0;
  transition: opacity 0.45s ease;
}

/* Center wrapper inside overlay to host the coin DOM node */
.overlay-center {
  display: flex;
  align-items: center;
  justify-content: center;
}

/* -------- Estado dentro del overlay -------- */
.overlay-status-container {
  position: absolute;
  top: 12%;
  left: 0;
  width: 100%;
  text-align: center;
  color: #0dcaf0; /* igual que .text-info */
  font-size: 1.8rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-shadow: 0 0 10px rgba(13,202,240,0.4);
  pointer-events: none; /* no interfiere con clics */
}

/* Small responsive adjustments */
@media (max-width: 768px) {
  .coin-wrapper { width: 120px; height: 120px; }
  .coin.in-overlay { width: clamp(160px, 60vw, 240px); height: clamp(160px,60vw,240px); }
  .face .emoji { font-size: 2.6rem; }
  .face .label { font-size: 0.8rem; }
}
</style>
{% endblock %}
