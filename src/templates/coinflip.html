{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-8">
    <div class="card game-card">
      <div class="card-header">
        <i class="fas fa-coins me-2"></i>
        Cara o Cruz
      </div>
      <div class="card-body">
        <!-- Panel de informaciÃ³n -->
        <div class="row mb-4">
          <div class="col-md-4 text-center">
            <div class="text-muted">Saldo</div>
            <h3>$<span id="balance">{{ "%.2f"|format(current_user.balance) }}</span></h3>
          </div>
          <div class="col-md-4 text-center">
            <div class="text-muted">Estado</div>
            <h3 id="estado-sistema" class="text-info">En espera</h3>
          </div>
          <div class="col-md-4 text-center">
            <div class="text-muted">Ãšltimo resultado</div>
            <h3 id="ultimo-resultado" class="text-secondary">$0.00</h3>
          </div>
        </div>

        <!-- Controles -->
        <div class="row mb-4">
          <div class="col-md-6 mb-3">
            <label class="form-label">
              <i class="fas fa-money-bill-wave me-2"></i> Apuesta
            </label>
            <div class="input-group">
              <span class="input-group-text bg-dark text-light">
                <i class="fas fa-dollar-sign"></i>
              </span>
              <input type="number" id="cantidad" class="form-control" min="1" max="{{ current_user.balance }}" value="10">
              <button class="btn btn-outline-primary" onclick="apuestaRapida(25)">25</button>
              <button class="btn btn-outline-primary" onclick="apuestaRapida(50)">50</button>
              <button class="btn btn-outline-primary" onclick="apuestaRapida(100)">100</button>
            </div>
          </div>

          <div class="col-md-6 text-center">
            <label class="form-label">
              <i class="fas fa-hand-pointer me-2"></i>Elige tu lado
            </label>
            <div>
              <button class="btn btn-outline-danger btn-lg me-2" id="btn-cara" onclick="seleccionarLado('cara')">
                <i class="fas fa-crown me-2"></i>Cara
              </button>
              <button class="btn btn-outline-success btn-lg" id="btn-cruz" onclick="seleccionarLado('cruz')">
                <i class="fas fa-leaf me-2"></i>Cruz
              </button>
            </div>
          </div>
        </div>

        <!-- Moneda -->
        <div class="text-center my-5">
          <div class="coin-container" onclick="lanzarMoneda()">
            <div id="moneda" class="coin">
              <div class="cara">
                <span>ðŸª™</span>
                <small>CARA</small>
              </div>
              <div class="cruz">
                <span>ðŸŒ¿</span>
                <small>CRUZ</small>
              </div>
            </div>
          </div>
          <div id="estado-moneda" class="mt-3 text-muted">Selecciona cara o cruz</div>
        </div>

        <div class="text-center">
          <button id="btn-lanzar" class="btn btn-primary btn-lg" onclick="lanzarMoneda()">
            <i class="fas fa-rocket me-2"></i>Lanzar moneda
          </button>
        </div>

        <div id="resultado" class="mt-4"></div>

        <div class="mt-4">
          <h5>Historial de jugadas</h5>
          <ul id="historial" class="list-group small"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let ladoSeleccionado = null;
let enLanzamiento = false;
const historial = [];

function apuestaRapida(cantidad) {
  document.getElementById('cantidad').value = cantidad;
}

function seleccionarLado(lado) {
  if (enLanzamiento) return;

  const btnCara = document.getElementById('btn-cara');
  const btnCruz = document.getElementById('btn-cruz');

  // Si se pulsa dos veces el mismo botÃ³n, deseleccionar
  if (ladoSeleccionado === lado) {
    ladoSeleccionado = null;
    btnCara.classList.replace('btn-danger', 'btn-outline-danger');
    btnCruz.classList.replace('btn-success', 'btn-outline-success');
    document.getElementById('estado-moneda').textContent = 'Selecciona cara o cruz';
    return;
  }

  ladoSeleccionado = lado;
  btnCara.classList.toggle('btn-danger', lado === 'cara');
  btnCara.classList.toggle('btn-outline-danger', lado !== 'cara');
  btnCruz.classList.toggle('btn-success', lado === 'cruz');
  btnCruz.classList.toggle('btn-outline-success', lado !== 'cruz');
  document.getElementById('estado-moneda').textContent = `Has elegido ${lado.toUpperCase()}`;
}

function lanzarMoneda() {
  const cantidad = parseFloat(document.getElementById('cantidad').value);
  const moneda = document.getElementById('moneda');
  const balanceActual = parseFloat(document.getElementById('balance').textContent);

  if (!ladoSeleccionado) return alert("Selecciona cara o cruz antes de lanzar.");
  if (cantidad <= 0 || isNaN(cantidad)) return alert("Introduce una apuesta vÃ¡lida.");
  if (cantidad > balanceActual) return alert("Saldo insuficiente.");
  if (enLanzamiento) return;

  enLanzamiento = true;
  document.getElementById('btn-lanzar').disabled = true;
  document.getElementById('estado-sistema').textContent = 'Lanzando...';
  document.getElementById('estado-moneda').textContent = 'La moneda estÃ¡ girando...';

  // ðŸ”„ Reiniciar animaciÃ³n (forzar reflow)
  moneda.classList.remove('flip-cara', 'flip-cruz');
  void moneda.offsetWidth; // <- truco para reiniciar animaciÃ³n

  // ðŸ”¢ Generar resultado aleatorio
  const resultado = Math.random() < 0.5 ? 'cara' : 'cruz';

  // RotaciÃ³n aleatoria real (no fija)
  const vueltas = Math.floor(Math.random() * 4) + 5; // entre 5 y 8 vueltas
  moneda.style.setProperty('--vueltas', vueltas);
  moneda.classList.add(resultado === 'cara' ? 'flip-cara' : 'flip-cruz');

  setTimeout(() => ejecutarResultado(resultado, cantidad), 3000);
}

function ejecutarResultado(resultado, cantidad) {
  const gano = resultado === ladoSeleccionado;

  fetch('/api/coinflip/apostar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      cantidad: cantidad,
      eleccion: ladoSeleccionado,
      resultado_moneda: resultado
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }

    const { nuevo_balance, ganancia } = data;

    // âœ… Actualizar saldo dinÃ¡micamente
    const balanceSpan = document.getElementById('balance');
    const balanceAntiguo = parseFloat(balanceSpan.textContent);
    balanceSpan.textContent = nuevo_balance.toFixed(2);

    // PequeÃ±a animaciÃ³n de feedback
    balanceSpan.style.transition = 'color 0.5s';
    balanceSpan.style.color = nuevo_balance > balanceAntiguo ? 'limegreen' : 'red';
    setTimeout(() => (balanceSpan.style.color = ''), 800);

    document.getElementById('ultimo-resultado').textContent = `$${ganancia.toFixed(2)}`;
    document.getElementById('ultimo-resultado').style.color = gano ? 'green' : 'red';

    mostrarResultado(gano, resultado, cantidad, ganancia);
  })
  .finally(() => {
    enLanzamiento = false;
    document.getElementById('btn-lanzar').disabled = false;
  });
}

function mostrarResultado(gano, resultado, cantidad, ganancia) {
  const div = document.getElementById('resultado');
  div.innerHTML = gano
    ? `<div class="alert alert-success text-center">
         ðŸŽ‰ Â¡Has ganado! SaliÃ³ ${resultado.toUpperCase()} <br>
         <strong>Ganancia: $${ganancia.toFixed(2)}</strong>
       </div>`
    : `<div class="alert alert-danger text-center">
         ðŸ˜¢ Has perdido. SaliÃ³ ${resultado.toUpperCase()} <br>
         <strong>Perdiste: $${cantidad.toFixed(2)}</strong>
       </div>`;

  historial.unshift(`${resultado.toUpperCase()} - ${gano ? 'Ganado' : 'Perdido'}`);
  if (historial.length > 5) historial.pop();
  document.getElementById('historial').innerHTML =
    historial.map(h => `<li class="list-group-item">${h}</li>`).join('');

  // ðŸ”„ Reset visual de botones
  const btnCara = document.getElementById('btn-cara');
  const btnCruz = document.getElementById('btn-cruz');
  btnCara.classList.replace('btn-danger', 'btn-outline-danger');
  btnCruz.classList.replace('btn-success', 'btn-outline-success');

  ladoSeleccionado = null;
  document.getElementById('estado-sistema').textContent = 'En espera';
  document.getElementById('estado-moneda').textContent = 'Selecciona cara o cruz';
}
</script>

<style>
.coin-container {
  perspective: 1000px;
  width: 160px;
  height: 160px;
  margin: 0 auto;
}

.coin {
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 1s;
}

.coin .cara, .coin .cruz {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: radial-gradient(circle, gold 0%, orange 80%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-family: 'Orbitron', sans-serif;
  color: #333;
  border: 3px solid #b8860b;
  backface-visibility: hidden;
}

.coin .cruz {
  transform: rotateY(180deg);
  background: radial-gradient(circle, silver 0%, #999 80%);
}

.flip-cara {
  animation: flipCara 3s cubic-bezier(0.23, 1, 0.32, 1);
}

.flip-cruz {
  animation: flipCruz 3s cubic-bezier(0.23, 1, 0.32, 1);
}

@keyframes flipCara {
  0% { transform: rotateY(0deg); }
  100% { transform: rotateY(calc(360deg * var(--vueltas))); }
}

@keyframes flipCruz {
  0% { transform: rotateY(0deg); }
  100% { transform: rotateY(calc(180deg + 360deg * var(--vueltas))); }
}
</style>
{% endblock %}
